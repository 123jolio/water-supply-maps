# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import os
import numpy as np
import folium
from streamlit_folium import st_folium
import plotly.express as px
import plotly.graph_objects as go
from io import BytesIO
import re 

# Comprehensive Greek Regions and Prefectures with coordinates
GREEK_PREFECTURES_COORDS = {
    # Î‘Î½Î±Ï„Î¿Î»Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·
    'ÎˆÎ²ÏÎ¿Ï‚': {'lat': 40.8477, 'lon': 25.8738, 'region': 'Î‘Î½Î±Ï„Î¿Î». ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·', 'color': '#FF6B6B'},
    'ÎÎ¬Î½Î¸Î·': {'lat': 41.1355, 'lon': 24.8882, 'region': 'Î‘Î½Î±Ï„Î¿Î». ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·', 'color': '#FF6B6B'},
    'Î¡Î¿Î´ÏŒÏ€Î·': {'lat': 41.1179, 'lon': 25.4064, 'region': 'Î‘Î½Î±Ï„Î¿Î». ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·', 'color': '#FF6B6B'},
    'ÎšÎ±Î²Î¬Î»Î±': {'lat': 40.9396, 'lon': 24.4019, 'region': 'Î‘Î½Î±Ï„Î¿Î». ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·', 'color': '#FF6B6B'},
    'Î”ÏÎ¬Î¼Î±': {'lat': 41.1533, 'lon': 24.1428, 'region': 'Î‘Î½Î±Ï„Î¿Î». ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·', 'color': '#FF6B6B'},
    
    # ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±
    'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·': {'lat': 40.6401, 'lon': 22.9444, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î—Î¼Î±Î¸Î¯Î±': {'lat': 40.5167, 'lon': 22.2, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î Î­Î»Î»Î±': {'lat': 40.8, 'lon': 22.5, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î Î¹ÎµÏÎ¯Î±': {'lat': 40.3, 'lon': 22.6, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î£Î­ÏÏÎµÏ‚': {'lat': 41.0856, 'lon': 23.5469, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'ÎšÎ¹Î»ÎºÎ¯Ï‚': {'lat': 40.9939, 'lon': 22.8750, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®': {'lat': 40.2, 'lon': 23.3, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},
    'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚': {'lat': 40.16, 'lon': 24.28, 'region': 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#4ECDC4'},

    # Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±
    'ÎšÎ¿Î¶Î¬Î½Î·': {'lat': 40.30, 'lon': 21.78, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#A569BD'},
    'Î“ÏÎµÎ²ÎµÎ½Î¬': {'lat': 40.0833, 'lon': 21.4167, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#A569BD'},
    'ÎšÎ±ÏƒÏ„Î¿ÏÎ¹Î¬': {'lat': 40.5167, 'lon': 21.2667, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#A569BD'},
    'Î¦Î»ÏÏÎ¹Î½Î±': {'lat': 40.7833, 'lon': 21.4167, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', 'color': '#A569BD'},

    # Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚
    'Î†ÏÏ„Î±': {'lat': 39.1667, 'lon': 20.9833, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#5DADE2'},
    'Î˜ÎµÏƒÏ€ÏÏ‰Ï„Î¯Î±': {'lat': 39.5, 'lon': 20.25, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#5DADE2'},
    'Î™Ï‰Î¬Î½Î½Î¹Î½Î±': {'lat': 39.6667, 'lon': 20.85, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#5DADE2'},
    'Î ÏÎ­Î²ÎµÎ¶Î±': {'lat': 39.0833, 'lon': 20.75, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#5DADE2'},
    
    # Î‘Ï„Ï„Î¹ÎºÎ®
    'Î‘Ï„Ï„Î¹ÎºÎ®': {'lat': 37.9838, 'lon': 23.7275, 'region': 'Î‘Ï„Ï„Î¹ÎºÎ®', 'color': '#45B7D1'},
    'Î†Î³Î¹Î¿ ÎŒÏÎ¿Ï‚': {'lat': 40.2575, 'lon': 24.3258, 'region': 'Î†Î³Î¹Î¿ ÎŒÏÎ¿Ï‚', 'color': '#D2B4DE'},
    'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)': {'lat': 37.4, 'lon': 23.5, 'region': 'Î‘Ï„Ï„Î¹ÎºÎ®', 'color': '#45B7D1'},
    
    # Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±
    'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±': {'lat': 39.6339, 'lon': 22.4194, 'region': 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', 'color': '#96CEB4'},
    'Î›Î¬ÏÎ¹ÏƒÎ±': {'lat': 39.6339, 'lon': 22.4194, 'region': 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', 'color': '#96CEB4'},
    'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±': {'lat': 39.3681, 'lon': 22.9426, 'region': 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', 'color': '#96CEB4'},
    'Î¤ÏÎ¯ÎºÎ±Î»Î±': {'lat': 39.555, 'lon': 21.768, 'region': 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', 'color': '#96CEB4'},
    'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±': {'lat': 39.364, 'lon': 21.921, 'region': 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', 'color': '#96CEB4'},
    
    # Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±
    'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±': {'lat': 38.5, 'lon': 22.5, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    'Î•ÏÎ²Î¿Î¹Î±': {'lat': 38.5, 'lon': 24.0, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    'Î’Î¿Î¹Ï‰Ï„Î¯Î±': {'lat': 38.367, 'lon': 23.1, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±': {'lat': 38.9, 'lon': 22.4, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    'Î¦Ï‰ÎºÎ¯Î´Î±': {'lat': 38.5, 'lon': 22.5, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    'Î•Ï…ÏÏ…Ï„Î±Î½Î¯Î±': {'lat': 38.9, 'lon': 21.6, 'region': 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', 'color': '#FFEAA7'},
    
    # Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±
    'Î‘Ï‡Î±ÎÎ±': {'lat': 38.2466, 'lon': 21.7346, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±', 'color': '#DDA0DD'},
    'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±': {'lat': 38.6, 'lon': 21.4, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±', 'color': '#DDA0DD'},
    'Î—Î»ÎµÎ¯Î±': {'lat': 37.8, 'lon': 21.3, 'region': 'Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±', 'color': '#DDA0DD'},
    
    # Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚
    'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚': {'lat': 37.5, 'lon': 22.3, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    'Î‘ÏÎ³Î¿Î»Î¯Î´Î±': {'lat': 37.5, 'lon': 22.8, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    'Î‘ÏÎºÎ±Î´Î¯Î±': {'lat': 37.4, 'lon': 22.3, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±': {'lat': 37.9, 'lon': 22.9, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    'Î›Î±ÎºÏ‰Î½Î¯Î±': {'lat': 37.0, 'lon': 22.4, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±': {'lat': 37.0, 'lon': 21.9, 'region': 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', 'color': '#98D8C8'},
    
    # Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬
    'ÎšÎ­ÏÎºÏ…ÏÎ±': {'lat': 39.6243, 'lon': 19.9217, 'region': 'Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬', 'color': '#F7DC6F'},
    'ÎšÎµÏ†Î±Î»Î»Î·Î½Î¯Î±': {'lat': 38.1742, 'lon': 20.5275, 'region': 'Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬', 'color': '#F7DC6F'},
    'Î™Î¸Î¬ÎºÎ·': {'lat': 38.364, 'lon': 20.722, 'region': 'Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬', 'color': '#F7DC6F'},
    'Î›ÎµÏ…ÎºÎ¬Î´Î±': {'lat': 38.8267, 'lon': 20.7033, 'region': 'Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬', 'color': '#F7DC6F'},
    'Î–Î¬ÎºÏ…Î½Î¸Î¿Ï‚': {'lat': 37.7833, 'lon': 20.9000, 'region': 'Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬', 'color': '#F7DC6F'},
    
    # ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿
    'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿': {'lat': 36.4, 'lon': 25.4, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚': {'lat': 37.0, 'lon': 25.0, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î”Ï‰Î´ÎµÎºÎ¬Î½Î·ÏƒÎ±': {'lat': 36.4, 'lon': 27.2, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎÎ¬Î¾Î¿Ï‚': {'lat': 37.1036, 'lon': 25.3779, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î Î¬ÏÎ¿Ï‚': {'lat': 37.084, 'lon': 25.148, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î˜Î®ÏÎ±': {'lat': 36.3932, 'lon': 25.4615, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î¤Î®Î½Î¿Ï‚': {'lat': 37.5375, 'lon': 25.1618, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î¡ÏŒÎ´Î¿Ï‚': {'lat': 36.434, 'lon': 28.217, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'Î†Î½Î´ÏÎ¿Ï‚': {'lat': 37.8333, 'lon': 24.9333, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚': {'lat': 36.95, 'lon': 26.9833, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎœÎ®Î»Î¿Ï‚': {'lat': 36.7467, 'lon': 24.4444, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎšÏ‰Ï‚': {'lat': 36.894, 'lon': 27.288, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎšÎ­Î± - ÎšÏÎ¸Î½Î¿Ï‚': {'lat': 37.65, 'lon': 24.3333, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    'ÎšÎ¬ÏÏ€Î±Î¸Î¿Ï‚': {'lat': 35.507, 'lon': 27.213, 'region': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#BB8FCE'},
    
    # Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿
    'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿': {'lat': 39.1, 'lon': 26.0, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    'Î›Î­ÏƒÎ²Î¿Ï‚': {'lat': 39.1, 'lon': 26.5, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    'ÎšÏÎ®Ï„Î·': {'lat': 35.2401, 'lon': 24.8093, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#FAD7A0'},
    'Î§Î¯Î¿Ï‚': {'lat': 38.4, 'lon': 26.1, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    'Î£Î¬Î¼Î¿Ï‚': {'lat': 37.7, 'lon': 26.8, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    'Î›Î®Î¼Î½Î¿Ï‚': {'lat': 39.9167, 'lon': 25.2500, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    'Î™ÎºÎ±ÏÎ¯Î±': {'lat': 37.6167, 'lon': 26.1500, 'region': 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', 'color': '#85C1E9'},
    
    # ÎšÏÎ®Ï„Î·
    'ÎšÏÎ®Ï„Î·': {'lat': 35.3, 'lon': 24.8, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#F8C471'},
    'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿': {'lat': 35.3387, 'lon': 25.1442, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#F8C471'},
    'Î§Î±Î½Î¹Î¬': {'lat': 35.5, 'lon': 23.8, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#F8C471'},
    'Î¡Î­Î¸Ï…Î¼Î½Î¿': {'lat': 35.4, 'lon': 24.5, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#F8C471'},
    'Î›Î±ÏƒÎ¯Î¸Î¹': {'lat': 35.2, 'lon': 25.7, 'region': 'ÎšÏÎ®Ï„Î·', 'color': '#F8C471'},
    
    # Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚
    'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚': {'lat': 39.5, 'lon': 20.5, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#82E0AA'},
    'Î™Ï‰Î¬Î½Î½Î¹Î½Î±': {'lat': 39.6650, 'lon': 20.8537, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#82E0AA'},
    'Î†ÏÏ„Î±': {'lat': 39.16, 'lon': 20.98, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#82E0AA'},
    'Î ÏÎ­Î²ÎµÎ¶Î±': {'lat': 38.96, 'lon': 20.75, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#82E0AA'},
    'Î˜ÎµÏƒÏ€ÏÏ‰Ï„Î¯Î±': {'lat': 39.5, 'lon': 20.2, 'region': 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', 'color': '#82E0AA'},
}

# Comprehensive DEYA to Prefecture mapping - Î ÎŸÎ›Î¥ Î•ÎšÎ¤Î•Î¤Î‘ÎœÎ•ÎÎŸ
DEYA_TO_PREFECTURE = {
    # Existing Entries...
    'Î”Î•Î¥Î‘ Î‘Î’Î”Î—Î¡Î©Î': 'ÎÎ¬Î½Î¸Î·', 'Î”Î•Î¥Î‘ Î‘Î’Î”Î—Î¡Î©Î ': 'ÎÎ¬Î½Î¸Î·',
    'Î”Î•Î¥Î‘ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ¥Î ÎŸÎ›Î—Î£': 'ÎˆÎ²ÏÎ¿Ï‚', 'Î”Î•Î¥Î‘ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎÎ ÎŸÎ›Î—Î£': 'ÎˆÎ²ÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ Î”Î™Î”Î¥ÎœÎŸÎ¤Î•Î™Î§ÎŸÎ¥': 'ÎˆÎ²ÏÎ¿Ï‚', 'Î”Î•Î¥Î‘ ÎŸÎ¡Î•Î£Î¤Î™Î‘Î”Î‘Î£': 'ÎˆÎ²ÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ ÎÎ‘ÎÎ˜Î—Î£': 'ÎÎ¬Î½Î¸Î·', 'Î”Î•Î¥Î‘ ÎÎ†ÎÎ˜Î—Î£': 'ÎÎ¬Î½Î¸Î·',
    'Î”Î•Î¥Î‘ ÎšÎŸÎœÎŸÎ¤Î—ÎÎ—Î£': 'Î¡Î¿Î´ÏŒÏ€Î·', 'Î”Î•Î¥Î‘ ÎšÎŸÎœÎŸÎ¤Î‰ÎÎ—Î£': 'Î¡Î¿Î´ÏŒÏ€Î·',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î’Î‘Î›Î‘Î£': 'ÎšÎ±Î²Î¬Î»Î±', 'Î”Î•Î¥Î‘ ÎšÎ‘Î’Î†Î›Î‘Î£': 'ÎšÎ±Î²Î¬Î»Î±',
    'Î”Î•Î¥Î‘ Î˜Î‘Î£ÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±', 'Î”Î•Î¥Î‘ Î˜Î†Î£ÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±',
    'Î”Î•Î¥Î‘ Î Î‘Î“Î“Î‘Î™ÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±', 'Î”Î•Î¥Î‘ Î Î‘Î“Î“Î‘ÎŠÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±',
    'Î”Î•Î¥Î‘ ÎÎ•Î£Î¤ÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±', 'Î”Î•Î¥Î‘ ÎÎˆÎ£Î¤ÎŸÎ¥': 'ÎšÎ±Î²Î¬Î»Î±', 'Î”Î•Î¥Î‘ ÎÎ•Î£Î¤ÎŸÎ¥ ': 'ÎšÎ±Î²Î¬Î»Î±',
    'Î”Î•Î¥Î‘ Î”Î¡Î‘ÎœÎ‘Î£': 'Î”ÏÎ¬Î¼Î±', 'Î”Î•Î¥Î‘ Î”Î¡Î†ÎœÎ‘Î£': 'Î”ÏÎ¬Î¼Î±',
    'Î”Î®Î¼Î¿Ï‚ Î”ÎŸÎÎ‘Î¤ÎŸÎ¥': 'Î”ÏÎ¬Î¼Î±', 'Î”Î®Î¼Î¿Ï‚ Î Î¡ÎŸÎ£ÎŸÎ¤Î£Î‘ÎÎ—Î£': 'Î”ÏÎ¬Î¼Î±',
    'Î”Î‰ÎœÎŸÎ£ Î Î¡ÎŸÎ£ÎŸÎ¤Î£Î†ÎÎ—Î£': 'Î”ÏÎ¬Î¼Î±', 'Î”Î®Î¼Î¿Ï‚ Î£ÎŸÎ¥Î¦Î›Î™ÎŸÎ¥': 'ÎˆÎ²ÏÎ¿Ï‚',
    'Î”Î®Î¼Î¿Ï‚ Î™Î‘Î£ÎœÎŸÎ¥': 'Î¡Î¿Î´ÏŒÏ€Î·', 'Î”Î®Î¼Î¿Ï‚ ÎœÎ‘Î¡Î©ÎÎ•Î™Î‘Î£ - Î£Î‘Î Î©Î': 'Î¡Î¿Î´ÏŒÏ€Î·',
    'Î”Î®Î¼Î¿Ï‚ ÎšÎ‘Î¤Î© ÎÎ•Î¥Î¡ÎŸÎšÎŸÎ Î™ÎŸÎ¥': 'Î”ÏÎ¬Î¼Î±', 'Î”Î®Î¼Î¿Ï‚ Î Î‘Î¡Î‘ÎÎ•Î£Î¤Î™ÎŸÎ¥': 'Î”ÏÎ¬Î¼Î±',
    'Î”Î®Î¼Î¿Ï‚ Î£Î‘ÎœÎŸÎ˜Î¡Î‘ÎšÎ—Î£': 'ÎˆÎ²ÏÎ¿Ï‚', 'Î”Î®Î¼Î¿Ï‚ Î¤ÎŸÎ Î•Î™Î¡ÎŸÎ¥': 'ÎÎ¬Î½Î¸Î·',
    'Î”Î®Î¼Î¿Ï‚ ÎœÎ¥ÎšÎ—Î£': 'ÎÎ¬Î½Î¸Î·', 'Î”Î‰ÎœÎŸÎ£ ÎœÎ¥ÎšÎ‰Î£': 'ÎÎ¬Î½Î¸Î·',
    'Î”Î•Î¥Î‘ Î˜Î•Î¡ÎœÎ‘ÎªÎšÎŸÎ¥': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·', 'Î”Î•Î¥Î‘ Î˜Î•Î¡ÎœÎ‘ÎªÎšÎŸÎ ': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î•Î¥Î‘ Î’Î•Î¡ÎŸÎ™Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±', 'Î”Î•Î¥Î‘ Î’ÎˆÎ¡ÎŸÎ™Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±',
    'Î”Î•Î¥Î‘ Î‘Î›Î•ÎÎ‘ÎÎ”Î¡Î•Î™Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±', 'Î”Î•Î¥Î‘ Î‘Î›Î•ÎÎ†ÎÎ”Î¡Î•Î™Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±',
    'Î”Î•Î¥Î‘ ÎˆÎ´ÎµÏƒÏƒÎ±Ï‚': 'Î Î­Î»Î»Î±', 'Î”Î•Î¥Î‘ Î•Î”Î•Î£Î£Î‘Î£': 'Î Î­Î»Î»Î±',
    'Î”Î•Î¥Î‘ Î‘Î›ÎœÎ©Î Î™Î‘Î£': 'Î Î­Î»Î»Î±', 'Î”Î•Î¥Î‘ Î‘Î›ÎœÎ©Î ÎŠÎ‘Î£': 'Î Î­Î»Î»Î±', 'Î”Î•Î¥Î‘ Î‘Î›ÎœÎ©Î Î™Î‘Î£ ': 'Î Î­Î»Î»Î±',
    'Î”Î•Î¥Î‘ Î”Î™ÎŸÎ¥-ÎŸÎ›Î¥ÎœÎ ÎŸÎ¥': 'Î Î¹ÎµÏÎ¯Î±', 'Î”Î•Î¥Î‘ Î”ÎŠÎŸÎ¥-ÎŸÎ›ÎÎœÎ ÎŸÎ¥': 'Î Î¹ÎµÏÎ¯Î±',
    'Î”Î•Î¥Î‘ Î’Î™Î£Î‘Î›Î¤Î™Î‘Î£': 'Î£Î­ÏÏÎµÏ‚', 'Î”Î•Î¥Î‘ Î’Î™Î£Î‘Î›Î¤ÎŠÎ‘Î£': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î•Î¥Î‘ Î—Î¡Î‘ÎšÎ›Î•Î™Î‘Î£': 'Î£Î­ÏÏÎµÏ‚', 'Î”Î•Î¥Î‘ Î—Î¡Î‘ÎšÎ›Î•ÎŠÎ‘Î£': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î•Î¥Î‘ Î’ÎŸÎ›Î’Î—Î£': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·', 'Î”Î•Î¥Î‘ Î’ÎŸÎ›Î’Î‰Î£': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·', 'Î”Î•Î¥Î‘ Î’ÎŸÎ›Î’Î—Î£ ': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î•Î¥Î‘ Î”Î—ÎœÎŸÎ¥ Î”Î•Î›Î¤Î‘': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·', 'Î”Î•Î¥Î‘ Î”Î‰ÎœÎŸÎ¥ Î”ÎˆÎ›Î¤Î‘': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î•Î¥Î‘ ÎšÎ™Î›ÎšÎ™Î£': 'ÎšÎ¹Î»ÎºÎ¯Ï‚', 'Î”Î•Î¥Î‘ ÎšÎ™Î›ÎšÎŠÎ£': 'ÎšÎ¹Î»ÎºÎ¯Ï‚',
    'Î•Î¥Î”Î‘Î ': 'Î‘Ï„Ï„Î¹ÎºÎ®', 'Î•.Î¥.Î”.Î‘.Î .': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î’ÎŸÎ›ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±', 'Î”Î•Î¥Î‘ Î’ÎŒÎ›ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î•Î¥Î‘ Î›Î‘Î¡Î™Î£Î‘Î£': 'Î›Î¬ÏÎ¹ÏƒÎ±', 'Î”Î•Î¥Î‘ Î›Î†Î¡Î™Î£Î‘Î£': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î¤Î¡Î™ÎšÎ‘Î›Î©Î': 'Î¤ÏÎ¯ÎºÎ±Î»Î±', 'Î”Î•Î¥Î‘ Î¤Î¡Î™ÎšÎ†Î›Î©Î': 'Î¤ÏÎ¯ÎºÎ±Î»Î±',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î¡Î”Î™Î¤Î£Î‘Î£': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±', 'Î”Î•Î¥Î‘ ÎšÎ‘Î¡Î”ÎŠÎ¤Î£Î‘Î£': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î•Î¥Î‘ ÎšÎ•Î¡ÎšÎ¥Î¡Î‘Î£': 'ÎšÎ­ÏÎºÏ…ÏÎ±', 'Î”Î•Î¥Î‘ ÎšÎˆÎ¡ÎšÎ¥Î¡Î‘Î£': 'ÎšÎ­ÏÎºÏ…ÏÎ±',
    'Î”Î•Î¥Î‘ ÎšÎ•Î¦Î‘Î›Î›Î—ÎÎ™Î‘Î£': 'ÎšÎµÏ†Î±Î»Î»Î·Î½Î¯Î±', 'Î”Î•Î¥Î‘ ÎšÎ•Î¦Î‘Î›Î›Î—ÎÎŠÎ‘Î£': 'ÎšÎµÏ†Î±Î»Î»Î·Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î–Î‘ÎšÎ¥ÎÎ˜ÎŸÎ¥': 'Î–Î¬ÎºÏ…Î½Î¸Î¿Ï‚', 'Î”Î•Î¥Î‘ Î–Î‘ÎšÎÎÎ˜ÎŸÎ¥': 'Î–Î¬ÎºÏ…Î½Î¸Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î›Î•Î¥ÎšÎ‘Î”ÎŸÎ£': 'Î›ÎµÏ…ÎºÎ¬Î´Î±', 'Î”Î•Î¥Î‘ Î›Î•Î¥ÎšÎ†Î”ÎŸÎ£': 'Î›ÎµÏ…ÎºÎ¬Î´Î±',
    'Î”Î•Î¥Î‘ Î‘Î™Î“Î™Î‘Î›Î•Î™Î‘Î£': 'Î‘Ï‡Î±ÎÎ±', 'Î”Î•Î¥Î‘ Î‘Î™Î“Î™Î‘Î›Î•ÎŠÎ‘Î£': 'Î‘Ï‡Î±ÎÎ±',
    'Î”Î•Î¥Î‘ Î Î‘Î¤Î¡Î‘Î£': 'Î‘Ï‡Î±ÎÎ±', 'Î”Î•Î¥Î‘ Î Î†Î¤Î¡Î‘Î£': 'Î‘Ï‡Î±ÎÎ±',
    'Î”Î•Î¥Î‘ ÎœÎ•Î£ÎŸÎ›ÎŸÎ“Î“Î™ÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±', 'Î”Î•Î¥Î‘ ÎœÎ•Î£ÎŸÎ›ÎŸÎ“Î“ÎŠÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î Î¥Î¡Î“ÎŸÎ¥': 'Î—Î»ÎµÎ¯Î±', 'Î”Î•Î¥Î‘ Î ÎÎ¡Î“ÎŸÎ¥': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î•Î¥Î‘ Î§Î‘Î›ÎšÎ™Î”Î‘Î£': 'Î•ÏÎ²Î¿Î¹Î±', 'Î”Î•Î¥Î‘ Î§Î‘Î›ÎšÎŠÎ”Î‘Î£': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î•Î¥Î‘ Î›Î™Î’Î‘Î”Î•Î™Î‘Î£': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±', 'Î”Î•Î¥Î‘ Î›Î™Î’Î‘Î”Î•ÎŠÎ‘Î£': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î•Î¥Î‘ Î›Î‘ÎœÎ™Î‘Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±', 'Î”Î•Î¥Î‘ Î›Î‘ÎœÎŠÎ‘Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î•Î¥Î‘ Î—Î¡Î‘ÎšÎ›Î•Î™ÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿', 'Î”Î•Î¥Î‘ Î—Î¡Î‘ÎšÎ›Î•ÎŠÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î•Î¥Î‘ Î§Î‘ÎÎ™Î©Î': 'Î§Î±Î½Î¹Î¬', 'Î”Î•Î¥Î‘ Î§Î‘ÎÎŠÎ©Î': 'Î§Î±Î½Î¹Î¬',
    'Î”Î•Î¥Î‘ Î¡Î•Î˜Î¥ÎœÎÎŸÎ¥': 'Î¡Î­Î¸Ï…Î¼Î½Î¿', 'Î”Î•Î¥Î‘ Î¡Î•Î˜ÎÎœÎÎŸÎ¥': 'Î¡Î­Î¸Ï…Î¼Î½Î¿',
    'Î”Î•Î¥Î‘ Î›Î‘Î£Î™Î˜Î™ÎŸÎ¥': 'Î›Î±ÏƒÎ¯Î¸Î¹', 'Î”Î•Î¥Î‘ Î›Î‘Î£Î™Î˜ÎŠÎŸÎ¥': 'Î›Î±ÏƒÎ¯Î¸Î¹',
    'Î”Î•Î¥Î‘ Î™Î©Î‘ÎÎÎ™ÎÎ©Î': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±', 'Î”Î•Î¥Î‘ Î™Î©Î‘ÎÎÎŠÎÎ©Î': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î•Î¥Î‘ Î‘Î¡Î¤Î‘Î£': 'Î†ÏÏ„Î±', 'Î”Î•Î¥Î‘ Î†Î¡Î¤Î‘Î£': 'Î†ÏÏ„Î±',
    'Î”Î•Î¥Î‘ Î Î¡Î•Î’Î•Î–Î‘Î£': 'Î ÏÎ­Î²ÎµÎ¶Î±', 'Î”Î•Î¥Î‘ Î Î¡ÎˆÎ’Î•Î–Î‘Î£': 'Î ÏÎ­Î²ÎµÎ¶Î±',
    'Î”Î•Î¥Î‘ ÎšÎŸÎ¡Î™ÎÎ˜ÎŸÎ¥': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±', 'Î”Î•Î¥Î‘ ÎšÎŸÎ¡ÎŠÎÎ˜ÎŸÎ¥': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±',
    'Î”Î•Î¥Î‘ Î‘Î¡Î“ÎŸÎ›Î™Î”Î‘Î£': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±', 'Î”Î•Î¥Î‘ Î‘Î¡Î“ÎŸÎ›ÎŠÎ”Î‘Î£': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±',
    'Î”Î•Î¥Î‘ Î£Î Î‘Î¡Î¤Î—Î£': 'Î›Î±ÎºÏ‰Î½Î¯Î±', 'Î”Î•Î¥Î‘ Î£Î Î†Î¡Î¤Î—Î£': 'Î›Î±ÎºÏ‰Î½Î¯Î±',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î›Î‘ÎœÎ‘Î¤Î‘Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±', 'Î”Î•Î¥Î‘ ÎšÎ‘Î›Î‘ÎœÎ†Î¤Î‘Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î¤Î¡Î™Î ÎŸÎ›Î—Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±', 'Î”Î•Î¥Î‘ Î¤Î¡ÎŠÎ ÎŸÎ›Î—Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î•Î¥Î‘ Î£Î¥Î¡ÎŸÎ¥': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚', 'Î”Î•Î¥Î‘ Î£ÎÎ¡ÎŸÎ¥': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚',
    'Î”Î•Î¥Î‘ ÎœÎ¥ÎšÎŸÎÎŸÎ¥': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚', 'Î”Î•Î¥Î‘ ÎœÎ¥ÎšÎŒÎÎŸÎ¥': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚',
    'Î”Î•Î¥Î‘ Î£Î‘ÎÎ¤ÎŸÎ¡Î™ÎÎ—Î£': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚', 'Î”Î•Î¥Î‘ Î£Î‘ÎÎ¤ÎŸÎ¡ÎŠÎÎ—Î£': 'ÎšÏ…ÎºÎ»Î¬Î´ÎµÏ‚',
    'Î”Î•Î¥Î‘ Î¡ÎŸÎ”ÎŸÎ¥': 'Î”Ï‰Î´ÎµÎºÎ¬Î½Î·ÏƒÎ±', 'Î”Î•Î¥Î‘ Î¡ÎŒÎ”ÎŸÎ¥': 'Î”Ï‰Î´ÎµÎºÎ¬Î½Î·ÏƒÎ±',
    'Î”Î•Î¥Î‘ ÎšÎ©': 'Î”Ï‰Î´ÎµÎºÎ¬Î½Î·ÏƒÎ±', 'Î”Î•Î¥Î‘ ÎšÎ©Î£': 'Î”Ï‰Î´ÎµÎºÎ¬Î½Î·ÏƒÎ±',
    'Î”Î•Î¥Î‘ ÎœÎ¥Î¤Î™Î›Î—ÎÎ—Î£': 'Î›Î­ÏƒÎ²Î¿Ï‚', 'Î”Î•Î¥Î‘ ÎœÎ¥Î¤Î™Î›Î‰ÎÎ—Î£': 'Î›Î­ÏƒÎ²Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î§Î™ÎŸÎ¥': 'Î§Î¯Î¿Ï‚', 'Î”Î•Î¥Î‘ Î§ÎŠÎŸÎ¥': 'Î§Î¯Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î£Î‘ÎœÎŸÎ¥': 'Î£Î¬Î¼Î¿Ï‚', 'Î”Î•Î¥Î‘ Î£Î†ÎœÎŸÎ¥': 'Î£Î¬Î¼Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î›Î—ÎœÎÎŸÎ¥': 'Î›Î®Î¼Î½Î¿Ï‚', 'Î”Î•Î¥Î‘ Î›Î‰ÎœÎÎŸÎ¥': 'Î›Î®Î¼Î½Î¿Ï‚',
    
    # --- ÎÎ•Î•Î£ Î Î¡ÎŸÎ£Î˜Î—ÎšÎ•Î£ ---
    'Î”Î•Î¥Î‘ Î’ÎŸÎ¡Î•Î™ÎŸÎ¥ Î‘ÎÎŸÎÎ‘ Î§Î‘ÎÎ™Î©Î': 'Î§Î±Î½Î¹Î¬',
    'Î”Î•Î¥Î‘ Î˜Î—Î’Î‘Î™Î©Î': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ©Î“Î•Î™Î©Î': 'Î¡Î­Î¸Ï…Î¼Î½Î¿',
    'Î”Î•Î¥Î‘ Î Î‘Î™ÎŸÎÎ™Î‘Î£': 'ÎšÎ¹Î»ÎºÎ¯Ï‚',
    'Î”Î•Î¥Î‘ Î§Î‘Î›ÎšÎ—Î”ÎŸÎÎŸÎ£': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î•Î¥Î‘ ÎšÎ¥ÎœÎ—Î£ - Î‘Î›Î™Î’Î•Î¡Î™ÎŸÎ¥': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î•Î¥Î‘. Î”Î™ÎŸÎ¥ ÎŸÎ›Î¥ÎœÎ ÎŸÎ¥': 'Î Î¹ÎµÏÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î›Î—ÎœÎÎŸÎ¥': 'Î›Î®Î¼Î½Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î›Î•Î£Î’ÎŸÎ¥': 'Î›Î­ÏƒÎ²Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î£Î•Î¡Î¡Î©Î': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î•Î¥Î‘ Î‘Î“Î¡Î™ÎÎ™ÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î Î¥Î›ÎŸÎ¥-ÎÎ•Î£Î¤ÎŸÎ¡ÎŸÎ£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î”Î•Î›Î¦Î©Î': 'Î¦Ï‰ÎºÎ¯Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎŸÎ¡Î“ÎŸÎ¥': 'ÎÎ¬Î¾Î¿Ï‚',
    'Î”Î•Î¥Î‘ ÎœÎ‘Î›Î•Î’Î™Î–Î™ÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î•Î¥Î‘ Î Î‘Î¡ÎŸÎ¥': 'Î Î¬ÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î¦Î¥Î›Î—Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ ÎœÎ•Î¤Î•Î©Î¡Î©Î': 'Î¤ÏÎ¯ÎºÎ±Î»Î±',
    'Î”Î•Î¥Î‘ Î˜Î—Î¡Î‘Î£': 'Î˜Î®ÏÎ±',
    'Î”Î—ÎœÎŸÎ£ Î¤Î—ÎÎŸÎ¥': 'Î¤Î®Î½Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î£ÎšÎŸÎ Î•Î›ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î•Î¥Î‘ Î•Î¡ÎœÎ™ÎŸÎÎ™Î”Î‘Î£ (ÎšÎ¡Î‘ÎÎ™Î”Î™ÎŸÎ¥)': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ‘ÎšÎ¡Î‘ÎšÎ©ÎœÎ—Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î•Î¥Î‘ Î¤Î¥Î¡ÎÎ‘Î’ÎŸÎ¥': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î•Î¥Î‘ ÎšÎ•Î¦Î‘Î›ÎŸÎÎ™Î‘Î£': 'ÎšÎµÏ†Î±Î»Î»Î·Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎÎ‘ÎÎŸÎ¥ ÎšÎ‘Î™ ÎœÎ™ÎšÎ¡Î©Î ÎšÎ¥ÎšÎ›Î‘Î”Î©Î': 'ÎÎ¬Î¾Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎœÎŸÎÎ•ÎœÎ’Î‘Î£Î™Î‘Î£': 'Î›Î±ÎºÏ‰Î½Î¯Î±',
    'Î”Î•Î¥Î‘ ÎœÎ™ÎÎ©Î‘ Î Î•Î”Î™Î‘Î”Î‘Î£': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î•Î¥Î‘ Î Î‘Î¤Î¡Î•Î©Î': 'Î‘Ï‡Î±ÎÎ±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î¡Î™Î£Î¤ÎŸÎ¤Î•Î›Î—': 'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î§Î•Î¡Î£ÎŸÎÎ—Î£ÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î—ÎœÎŸÎ£ Î‘Î¡Î§Î‘ÎÎ©Î Î‘Î£Î¤Î•Î¡ÎŸÎ¥Î£Î™Î©Î': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î•Î¥Î‘ Î‘Î¡Î“ÎŸÎ¥Î£ - ÎœÎ¥ÎšÎ—ÎÎ©Î': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±',
    'ÎŸÎ¡Î“Î‘ÎÎ™Î£ÎœÎŸÎ£ Î‘ÎÎ‘Î Î¤Î¥ÎÎ—Î£ ÎšÎ¡Î—Î¤Î—Î£ Î‘.Î•. (ÎŸÎ‘Îš Î‘Î•)': 'ÎšÏÎ®Ï„Î·',
    'Î”Î•Î¥Î‘ Î•Î›Î‘Î£Î£ÎŸÎÎ‘Î£': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ¥ÎÎ¤Î‘Î™ÎŸÎ¥': 'Î¦Î»ÏÏÎ¹Î½Î±',
    'Î”Î•Î¥Î‘ Î Î‘Î›Î‘ÎœÎ‘': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ¦Î™ÎšÎ›Î•Î™Î‘Î£ -Î•Î›Î‘Î¤Î•Î™Î‘Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ¦Î™Î›ÎŸÎ§Î™Î‘Î£': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î¡Î“ÎŸÎ¥Î£ ÎŸÎ¡Î•Î£Î¤Î™ÎšÎŸÎ¥': 'ÎšÎ±ÏƒÏ„Î¿ÏÎ¹Î¬',
    'Î™Îœ ÎœÎ•Î“Î™Î£Î¤Î—Î£ Î›Î‘Î¥Î¡Î‘Î£': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î“Î‘Î¥Î”ÎŸÎ¥': 'Î§Î±Î½Î¹Î¬',
    'Î”Î•Î¥Î‘ ÎÎ¥Î›ÎŸÎšÎ‘Î£Î¤Î¡ÎŸÎ¥ - Î•Î¥Î¡Î©Î£Î¤Î™ÎÎ—Î£': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎŸÎ™Î§Î‘Î›Î™Î‘Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î£Î¤ÎŸÎ¡Î™Î‘Î£': 'ÎšÎ±ÏƒÏ„Î¿ÏÎ¹Î¬',
    'Î”Î•Î¥Î‘ Î’ÎŸÎªÎŸÎ¥': 'ÎšÎ¿Î¶Î¬Î½Î·',
    'Î”Î—ÎœÎŸÎ£ Î£Î•Î¡Î’Î™Î©Î': 'ÎšÎ¿Î¶Î¬Î½Î·',
    'Î”Î—ÎœÎŸÎ£ Î›Î™ÎœÎÎ—Î£ Î Î›Î‘Î£Î¤Î—Î¡Î‘': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î•Î¡Î•Î¤Î¡Î™Î‘Î£': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î•Î¥Î‘ ÎÎ‘Î¥Î Î›Î™Î•Î©Î': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î”Î¥Î¤Î™ÎšÎ—Î£ ÎœÎ‘ÎÎ—Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î’ÎŸÎ¡Î•Î™Î‘Î£ ÎšÎ¥ÎÎŸÎ¥Î¡Î™Î‘Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î•ÎœÎœÎ‘ÎÎŸÎ¥Î—Î› Î Î‘Î Î Î‘': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î—ÎœÎŸÎ£ Î”Î©Î”Î©ÎÎ—Î£': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î™Îœ Î£Î™ÎœÎ©ÎÎŸÎ£ Î Î•Î¤Î¡Î‘Î£': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î™Îœ ÎÎ•ÎÎŸÎ¦Î©ÎÎ¤ÎŸÎ£': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘. Î Î•Î›Î›Î‘Î£': 'Î Î­Î»Î»Î±',
    'Î”Î—ÎœÎŸÎ£ Î›Î•Î¥ÎšÎ‘Î”Î‘Î£': 'Î›ÎµÏ…ÎºÎ¬Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î¡Î•Î’Î•Î–Î—Î£': 'Î ÏÎ­Î²ÎµÎ¶Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î‘Î¡Î“Î‘Î£': 'Î ÏÎ­Î²ÎµÎ¶Î±',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ•Î¤Î£ÎŸÎ’ÎŸÎ¥': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ ÎÎ—Î¡ÎŸÎœÎ•Î¡ÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î”Î©Î¡Î™Î”ÎŸÎ£': 'Î¦Ï‰ÎºÎ¯Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î“ÎŸÎ¡Î¤Î¥ÎÎ™Î‘Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î™Î•Î¡Î‘Î Î•Î¤Î¡Î‘Î£': 'Î›Î±ÏƒÎ¯Î¸Î¹',
    'Î”Î—ÎœÎŸÎ£ Î›ÎŸÎšÎ¡Î©Î': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î”Î™Î£Î¤ÎŸÎœÎŸÎ¥ - Î‘Î¡Î‘Î§ÎŸÎ’Î‘Î£ - Î‘ÎÎ¤Î™ÎšÎ¥Î¡Î‘Î£': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘Î¡Î¥Î£Î¤ÎŸÎ¥': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î—ÎœÎŸÎ£ Î¤Î¡ÎŸÎ™Î–Î—ÎÎ™Î‘Î£ ÎœÎ•Î˜Î‘ÎÎ©Î': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î¦Î™Î›Î™Î‘Î¤Î©Î': 'Î˜ÎµÏƒÏ€ÏÏ‰Ï„Î¯Î±',
    'Î”Î•Î¥Î‘ Î¦Î‘Î¡Î£Î‘Î›Î©Î': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î‘Î¡Î§Î‘Î™Î‘Î£ ÎŸÎ›Î¥ÎœÎ Î™Î‘Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î–Î™Î¤Î£Î‘Î£': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ Î£Î•Î¡Î™Î¦ÎŸÎ¥': 'ÎœÎ®Î»Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘Î“Î™ÎŸÎ¥ Î•Î¥Î£Î¤Î¡Î‘Î¤Î™ÎŸÎ¥': 'Î›Î®Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ•Î“Î‘Î›ÎŸÎ ÎŸÎ›Î—Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î¤Î—Î›ÎŸÎ¥': 'Î¡ÏŒÎ´Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î Î¡Î•Î£Î Î©Î': 'Î¦Î»ÏÏÎ¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎšÎ¤Î™ÎŸÎ¥ - Î’ÎŸÎÎ™Î¤Î£Î‘Î£': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î•Î¥Î‘ ÎÎ‘Î¥Î Î‘ÎšÎ¤Î™Î‘Î£': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î•Î¥Î‘ Î§Î‘Î›ÎšÎ™Î”Î•Î©Î': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î•Î¥Î‘ Î›ÎŸÎ¥Î¤Î¡Î‘ÎšÎ™ÎŸÎ¥ - Î Î•Î¡Î‘Î§Î©Î¡Î‘Î£': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±',
    'Î”Î•Î¥Î‘ Î£Î™ÎšÎ¥Î©ÎÎ™Î©Î': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î“Î¡Î‘Î¦Î©Î': 'Î•Ï…ÏÏ…Ï„Î±Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î£Î¤Î¥Î›Î™Î”Î‘Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ”Î¡ÎŸÎ¥': 'Î†Î½Î´ÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î•Î¥Î¡Î©Î¤Î‘': 'Î›Î±ÎºÏ‰Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î£Î¤Î¥Î Î‘Î›Î‘Î™Î‘Î£': 'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘Î›Î™Î‘Î¡Î¤ÎŸÎ¥ Î˜Î•Î£Î Î•Î©Î': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î•Î¥Î‘ Î£ÎšÎ¥Î”Î¡Î‘Î£': 'Î Î­Î»Î»Î±',
    'Î”Î•Î¥Î‘ Î˜Î•Î¡ÎœÎ—Î£': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ Î›Î•ÎšÎ‘ÎÎŸÎ Î•Î”Î™ÎŸÎ¥ Î™Î©Î‘ÎÎÎ™ÎÎ©Î': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î•Î¥Î‘ Î¡Î—Î“Î‘ Î¦Î•Î¡Î‘Î™ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î£ÎŸÎ¥Î›Î™ÎŸÎ¥': 'Î˜ÎµÏƒÏ€ÏÏ‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î›ÎŸÎÎÎ—Î£ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î•Î¥Î‘ Î Î¥Î›Î—Î£ Î¤Î¡Î™ÎšÎ‘Î›Î©Î': 'Î¤ÏÎ¯ÎºÎ±Î»Î±',
    'Î”Î•Î¥Î‘ Î£ÎšÎ™Î‘Î˜ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î’ÎŸÎ¡Î•Î™Î©Î Î¤Î–ÎŸÎ¥ÎœÎ•Î¡ÎšÎ©Î': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎŸÎÎ™Î¤Î£Î‘Î£': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î©Î“Î©ÎÎ™ÎŸÎ¥': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ‘Î¡Î™ÎŸÎ¥': 'Î¡Î­Î¸Ï…Î¼Î½Î¿',
    'Î”Î—ÎœÎŸÎ£ Î’Î•Î›ÎŸÎ¥ Î’ÎŸÎ§Î‘Î£': 'ÎšÎ¿ÏÎ¹Î½Î¸Î¯Î±',
    'Î”Î•Î¥Î‘ Î—Î“ÎŸÎ¥ÎœÎ•ÎÎ™Î¤Î£Î‘Î£': 'Î˜ÎµÏƒÏ€ÏÏ‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ•ÎÎ¤Î¡Î™ÎšÎ©Î Î¤Î–ÎŸÎ¥ÎœÎ•Î¡ÎšÎ©Î': 'Î†ÏÏ„Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î‘ÎÎ©Î': 'ÎšÎ­ÏÎºÏ…ÏÎ±',
    'Î”Î•Î¥Î‘ ÎœÎ¥Î›ÎŸÎ ÎŸÎ¤Î‘ÎœÎŸÎ¥': 'Î¡Î­Î¸Ï…Î¼Î½Î¿',
    'Î”Î•Î¥Î‘ Î£Î•Î›Î™ÎÎŸÎ¥': 'Î§Î±Î½Î¹Î¬',
    'Î”Î—ÎœÎŸÎ£ Î“ÎŸÎ¡Î¤Î¥ÎÎ‘Î£': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ•Î“Î‘Î¡Î•Î©Î': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î£Î¥ÎœÎ—Î£': 'Î¡ÏŒÎ´Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎŸÎ¡Î§ÎŸÎœÎ•ÎÎŸÎ¥': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘Î›Î‘Î’Î¡Î¥Î¤Î©Î': 'Î‘Ï‡Î±ÎÎ±',
    'Î™Îœ Î”ÎŸÎ§Î•Î™Î‘Î¡Î™ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ Î Î¥Î›Î‘Î™Î‘Î£ - Î§ÎŸÎ¡Î¤Î™Î‘Î¤Î—': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î™Îœ Î“Î¡Î—Î“ÎŸÎ¡Î™ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎÎ•Î‘Î£ Î Î¡ÎŸÎ ÎŸÎÎ¤Î™Î”Î‘Î£': 'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î‘Î¡Î¤Î‘Î™Î©Î': 'Î†ÏÏ„Î±',
    'Î”Î—ÎœÎŸÎ£ Î–Î—Î¡ÎŸÎ¥': 'Î ÏÎ­Î²ÎµÎ¶Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘ÎœÎ•ÎÎ©Î Î’ÎŸÎ¥Î¡Î›Î©Î': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î”ÎŸÎœÎŸÎšÎŸÎ¥': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î—ÎÎ•Î™ÎŸÎ¥': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ¥Î˜Î—Î¡Î©Î': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î•Î¥Î‘ Î£Î—Î¤Î•Î™Î‘Î£ Î›Î‘Î£Î™Î˜Î™ÎŸÎ¥': 'Î›Î±ÏƒÎ¯Î¸Î¹',
    'Î”Î—ÎœÎŸÎ£ Î§Î‘Î›ÎšÎ—Î£': 'Î¡ÏŒÎ´Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î›Î‘Î¥Î¡Î•Î©Î¤Î™ÎšÎ—Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î¡Î‘Î¦Î—ÎÎ‘Î£ - Î Î™ÎšÎ•Î¡ÎœÎ™ÎŸÎ¥': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ ÎœÎ•Î£Î£Î—ÎÎ—Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î ÎŸÎ¡ÎŸÎ¥': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î—Î¡Î©Î™ÎšÎ—Î£ Î. Î¨Î‘Î¡Î©Î': 'Î§Î¯Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î”Î¥Î¤Î™ÎšÎ—Î£ Î£Î‘ÎœÎŸÎ¥': 'Î£Î¬Î¼Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î¤Î¡Î™Î¦Î¥Î›Î™Î‘Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎÎŸÎ¤Î™Î‘Î£ ÎšÎ¥ÎÎŸÎ¥Î¡Î™Î‘Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î ÎŸÎ›Î¥Î“Î¥Î¡ÎŸÎ¥': 'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î–Î‘Î“ÎŸÎ¡Î™ÎŸÎ¥': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ Î–Î‘Î“ÎŸÎ¡Î‘Î£ - ÎœÎŸÎ¥Î¡Î•Î£Î™ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î•Î¥Î‘ Î–Î‘Î§Î‘Î¡Î©Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î•Î¥Î‘ Î¦Î›Î©Î¡Î™ÎÎ‘Î£': 'Î¦Î»ÏÏÎ¹Î½Î±',
    'Î”Î—ÎœÎŸÎ£ ÎÎ•Î£Î¤ÎŸÎ¡Î™ÎŸÎ¥': 'ÎšÎ±ÏƒÏ„Î¿ÏÎ¹Î¬',
    'Î”Î•Î¥Î‘ Î“Î¡Î•Î’Î•ÎÎ©Î': 'Î“ÏÎµÎ²ÎµÎ½Î¬',
    'Î™Îœ Î™Î’Î—Î¡Î©Î': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î™Îœ ÎÎ—Î¡ÎŸÎ ÎŸÎ¤Î‘ÎœÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î™Îœ Î Î‘ÎÎ¤ÎŸÎšÎ¡Î‘Î¤ÎŸÎ¡ÎŸÎ£': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î™Îœ Î–Î©Î“Î¡Î‘Î¦ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ Î›Î‘Î“ÎšÎ‘Î”Î‘': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î—ÎœÎŸÎ£ Î¤Î‘ÎÎ‘Î“Î¡Î‘Î£': 'Î’Î¿Î¹Ï‰Ï„Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ¥ Î£ÎšÎŸÎ¥Î¦Î‘': 'Î†ÏÏ„Î±',
    'Î”Î•Î¥Î‘ Î¦Î‘Î¡ÎšÎ‘Î”ÎŸÎÎ‘Î£': 'Î¤ÏÎ¯ÎºÎ±Î»Î±',
    'Î”Î•Î¥Î‘ Î‘Î›ÎœÎ¥Î¡ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î”Î™ÎŸÎÎ¥Î£ÎŸÎ¥': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘.ÎÎ‘ÎŸÎ¥Î£Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î“Î•Î©Î¡Î“Î™ÎŸÎ¥ ÎšÎ‘Î¡Î‘ÎªÎ£ÎšÎ‘ÎšÎ—': 'Î†ÏÏ„Î±',
    'Î™Îœ ÎšÎŸÎ¥Î¤Î›ÎŸÎ¥ÎœÎŸÎ¥Î£Î™ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ Î©Î¡Î‘Î™ÎŸÎšÎ‘Î£Î¤Î¡ÎŸÎ¥': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î™Îœ Î•Î£Î¦Î™Î“ÎœÎ•ÎÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ Î”Î¥ÎœÎ‘Î™Î©Î': 'Î‘Ï‡Î±ÎÎ±',
    'Î”Î•Î¥Î‘ Î‘Î“Î™Î‘Î£': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ Î™Î˜Î‘ÎšÎ—Î£': 'Î™Î¸Î¬ÎºÎ·',
    'Î™Îœ Î£Î¤Î‘Î¥Î¡ÎŸÎÎ™ÎšÎ—Î¤Î‘': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î’Î•Î›Î’Î•ÎÎ¤ÎŸÎ¥': 'ÎšÎ¿Î¶Î¬Î½Î·',
    'Î”Î•Î¥Î‘ Î£ÎŸÎ¦Î‘Î”Î©Î': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ•Î‘Î£': 'ÎšÎ­Î± - ÎšÏÎ¸Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ™Î£Î£Î‘ÎœÎŸÎ¥': 'Î§Î±Î½Î¹Î¬',
    'Î”Î—ÎœÎŸÎ£ Î‘Î ÎŸÎšÎŸÎ¡Î©ÎÎŸÎ¥': 'Î§Î±Î½Î¹Î¬',
    'Î”Î—ÎœÎŸÎ£ Î£Î Î‘Î¤Î©Î Î‘Î¡Î¤Î•ÎœÎ™Î”ÎŸÎ£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ ÎÎ™Î£Î¥Î¡ÎŸÎ¥': 'ÎšÏ‰Ï‚',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î›Î¥ÎœÎÎŸÎ¥': 'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î™Î£Î¤Î™Î‘Î™Î‘Î£ - Î‘Î™Î”Î—Î¨ÎŸÎ¥': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ‘ÎÎ”Î¡Î‘Î£-Î•Î™Î”Î¥Î›Î›Î™Î‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î‘Î™Î“Î™ÎÎ‘Î£': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î›Î•Î¡ÎŸÎ¥': 'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î£Î Î•Î¤Î£Î©Î': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î‘Î“ÎšÎ™Î£Î¤Î¡Î™ÎŸÎ¥': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î£ÎšÎ¥Î¡ÎŸÎ¥': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î—ÎœÎŸÎ£ Î•Î¡Î¥ÎœÎ‘ÎÎ˜ÎŸÎ¥': 'Î‘Ï‡Î±ÎÎ±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ¥Î˜ÎÎŸÎ¥': 'ÎšÎ­Î± - ÎšÏÎ¸Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î—Î¡Î©ÎªÎšÎ—Î£ ÎÎ—Î£ÎŸÎ¥ ÎšÎ‘Î£ÎŸÎ¥': 'ÎšÎ¬ÏÏ€Î±Î¸Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î”Î•Î£ÎšÎ‘Î¤Î—Î£': 'Î“ÏÎµÎ²ÎµÎ½Î¬',
    'Î™Îœ Î¦Î™Î›ÎŸÎ˜Î•ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î™Îœ Î§Î™Î›Î‘ÎÎ”Î‘Î¡Î™ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î Î¥Î”ÎÎ‘Î£-ÎšÎŸÎ›Î™ÎÎ”Î¡ÎŸÎ¥': 'Î Î¹ÎµÏÎ¯Î±',
    'Î”Î•Î¥Î‘ Î¦Î‘Î™Î£Î¤ÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î—ÎœÎŸÎ£ Î¦ÎŸÎ›Î•Î“Î‘ÎÎ”Î¡ÎŸÎ¥': 'Î˜Î®ÏÎ±',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ—Î›ÎŸÎ¥': 'ÎœÎ®Î»Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î£Î™ÎšÎ™ÎÎŸÎ¥': 'Î˜Î®ÏÎ±',
    'Î”Î—ÎœÎŸÎ£ ÎŸÎ™ÎÎŸÎ¥Î£Î£Î©Î': 'Î§Î¯Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î‘ÎÎ‘Î¤ÎŸÎ›Î™ÎšÎ—Î£ ÎœÎ‘ÎÎ—Î£': 'Î›Î±ÎºÏ‰Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ¡Î©Î Î™Î‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î£Î‘Î¡Î©ÎÎ™ÎšÎŸÎ¥': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î Î•Î›Î›Î‘Î£': 'Î Î­Î»Î»Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ¦Î™Î ÎŸÎ›Î—Î£': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î—ÎœÎŸÎ£ Î£Î™Î˜Î©ÎÎ™Î‘Î£': 'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘Î£Î£Î‘ÎÎ”Î¡Î‘Î£': 'Î§Î±Î»ÎºÎ¹Î´Î¹ÎºÎ®',
    'Î™Îœ Î’Î‘Î¤ÎŸÎ Î‘Î™Î”Î™ÎŸÎ¥': 'Î†Î³Î¹Î¿Î½ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ ÎÎ‘ÎŸÎ¥Î£Î‘Î£': 'Î—Î¼Î±Î¸Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î˜Î•Î¡ÎœÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î—Î›Î™Î”Î‘Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ ÎšÎ‘Î¡Î”Î™Î¤Î£Î‘Î£ ÎšÎ‘Î™ Î›ÎŸÎ™Î Î©Î Î”Î—ÎœÎ©Î': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ Î‘Î¡Î“Î™Î˜Î•Î‘Î£': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î£Î™ÎÎ¤Î™ÎšÎ—Î£': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î—ÎœÎŸÎ£ Î”Î™ÎŸÎ¥-ÎŸÎ›Î¥ÎœÎ ÎŸÎ¥': 'Î Î¹ÎµÏÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ‘Î¡ÎšÎŸÎ ÎŸÎ¥Î›ÎŸÎ¥ ÎœÎ•Î£ÎŸÎ“Î‘Î™Î‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ—Î¦Î™Î£Î™Î‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ ÎœÎ‘ÎÎ¤ÎŸÎ¥Î”Î™ÎŸÎ¥-Î›Î™ÎœÎÎ—Î£-Î‘Î“Î™Î‘Î£ Î‘ÎÎÎ‘Î£': 'Î•ÏÎ²Î¿Î¹Î±',
    'Î”Î™Î‘Î’Î‘Î˜ÎœÎ™Î”Î™ÎšÎŸÎ£ Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î—Î›Î•Î™Î‘Î£ Î¤Î—Î£ Î Î•Î¡Î™Î¦Î•Î¡Î•Î™Î‘Î£ Î”Î¥Î¤Î™ÎšÎ—Î£ Î•Î›Î›Î‘Î”Î‘Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘Î¡Î Î•ÎÎ—Î£Î™ÎŸÎ¥': 'Î•Ï…ÏÏ…Ï„Î±Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ”Î¡Î‘Î’Î™Î”Î‘Î£ - ÎšÎ¥Î›Î›Î—ÎÎ—Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ ÎŸ.Î¤.Î‘. Î. Î¦Î˜Î™Î©Î¤Î™Î”Î‘Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î Î‘Î™Î‘ÎÎ™Î‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î£Î‘Î›Î‘ÎœÎ™ÎÎ‘Î£': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î¥Î”Î¡Î‘Î£': 'ÎÎ®ÏƒÏ‰Î½ (Î‘Ï„Ï„Î¹ÎºÎ®)',
    'Î”Î—ÎœÎŸÎ£ Î©Î¡Î©Î Î™Î©Î': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î’Î¡Î™Î›Î—Î£Î£Î™Î©Î': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ‘Î¡Î Î‘Î˜ÎŸÎ¥': 'ÎšÎ¬ÏÏ€Î±Î¸Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘Î“Î‘Î˜ÎŸÎÎ—Î£Î™ÎŸÎ¥': 'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ‘Î¦Î—Î£': 'Î˜Î®ÏÎ±',
    'Î”Î—ÎœÎŸÎ£ Î•Î›Î‘Î¦ÎŸÎÎ—Î£ÎŸÎ¥': 'Î›Î±ÎºÏ‰Î½Î¯Î±',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ Î”Î—ÎœÎ©Î ÎšÎ‘Î›Î‘ÎœÎ‘Î¤Î‘Î£ - ÎœÎ•Î£Î£Î—ÎÎ—Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î›Î•Î™Î¨Î©Î': 'ÎšÎ¬Î»Ï…Î¼Î½Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎšÎ™ÎœÎ©Î›ÎŸÎ¥': 'ÎœÎ®Î»Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ¤Î™Î Î‘Î¡ÎŸÎ¥': 'Î Î¬ÏÎ¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î£Î™Î¦ÎÎŸÎ¥': 'ÎœÎ®Î»Î¿Ï‚',
    'Î Î•Î¡Î™Î¦Î•Î¡Î•Î™Î‘ ÎÎŸÎ¤Î™ÎŸÎ¥ Î‘Î™Î“Î‘Î™ÎŸÎ¥': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿',
    'Î”Î—ÎœÎŸÎ£Î™Î—Î¤Î©Î': 'Î˜Î®ÏÎ±', 
    'Î”Î—ÎœÎŸÎ£ ÎŸÎ¡ÎŸÎ Î•Î”Î™ÎŸÎ¥ Î›Î‘Î£Î™Î˜Î™ÎŸÎ¥': 'Î›Î±ÏƒÎ¯Î¸Î¹',
    'Î”Î—ÎœÎŸÎ£ Î£Î¦Î‘ÎšÎ™Î©Î': 'Î§Î±Î½Î¹Î¬',

    # Corrections for unmapped items
    'Î”Î•Î¥Î‘ ÎšÎ™Î›Î•Î›Î•Î¡': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î—ÎœÎŸÎ£ ÎÎŸÎ¤Î™ÎŸÎ¥ Î Î—Î›Î™ÎŸÎ¥': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±',
    'Î”Î•Î¥Î‘ Î’ÎŸÎ¡Î•Î™ÎŸÎ¥ Î‘ÎÎŸÎÎ‘ Î§Î‘ÎÎ™Î©Î': 'Î§Î±Î½Î¹Î¬',

    # New batch of unmapped items from user
    'Î™Îœ Î‘Î“Î™ÎŸÎ¥ Î Î‘Î¥Î›ÎŸÎ¥': 'Î†Î³Î¹Î¿ ÎŒÏÎ¿Ï‚',
    'Î”Î•Î¥Î‘ ÎšÎŸÎ–Î‘ÎÎ—Î£': 'ÎšÎ¿Î¶Î¬Î½Î·',
    'Î•Î¥Î‘Î˜': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·',
    'Î”Î•Î¥Î‘ ÎœÎŸÎ¥Î–Î‘ÎšÎ™ÎŸÎ¥': 'ÎšÎ±ÏÎ´Î¯Ï„ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î‘Î“Î™ÎŸÎ¥ ÎÎ™ÎšÎŸÎ›Î‘ÎŸÎ¥': 'Î›Î±ÏƒÎ¯Î¸Î¹',
    'Î”Î—ÎœÎŸÎ£ Î™ÎšÎ‘Î¡Î™Î‘Î£': 'Î£Î¬Î¼Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘Î“Î™ÎŸÎ¥ Î’Î‘Î£Î™Î›Î•Î™ÎŸÎ¥': 'Î¡Î­Î¸Ï…Î¼Î½Î¿',
    'Î”Î—ÎœÎŸÎ£ Î’Î™Î‘ÎÎÎŸÎ¥': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿',
    'Î”Î—ÎœÎŸÎ£ ÎÎ•Î‘Î£ Î–Î™Î§ÎÎ—Î£': 'Î£Î­ÏÏÎµÏ‚',
    'Î”Î•Î¥Î‘ ÎšÎ‘Î¤Î•Î¡Î™ÎÎ—Î£': 'Î Î¹ÎµÏÎ¯Î±',
    'Î”Î•Î¥Î‘ Î–Î‘ÎšÎ¥ÎÎ˜Î™Î©Î': 'Î–Î¬ÎºÏ…Î½Î¸Î¿Ï‚',
    'Î”Î•Î¥Î‘ Î¤Î•ÎœÎ Î©Î': 'Î›Î¬ÏÎ¹ÏƒÎ±',
    'Î”Î•Î¥Î‘ Î•ÎŸÎ¡Î”Î‘Î™Î‘Î£': 'ÎšÎ¿Î¶Î¬Î½Î·',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎÎ‘Î¤ÎŸÎ›Î™ÎšÎ—Î£ Î£Î‘ÎœÎŸÎ¥': 'Î£Î¬Î¼Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ ÎœÎ‘Î¡Î‘Î˜Î©ÎÎŸÎ£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î•Î¥Î‘ Î•Î Î™Î”Î‘Î¥Î¡ÎŸÎ¥': 'Î‘ÏÎ³Î¿Î»Î¯Î´Î±',
    'Î”Î—ÎœÎŸÎ£ Î¦ÎŸÎ¥Î¡ÎÎ©Î ÎšÎŸÎ¡Î£Î•Î©Î': 'Î£Î¬Î¼Î¿Ï‚',
    'Î”Î—ÎœÎŸÎ£ Î‘ÎœÎ¥ÎÎ¤Î‘Î™ÎŸÎ¥': 'Î¦Î»ÏÏÎ¹Î½Î±',
    'Î”Î•Î¥Î‘ Î’ÎŸÎ¡Î•Î™Î‘Î£ ÎšÎ¥ÎÎŸÎ¥Î¡Î™Î‘Î£': 'Î‘ÏÎºÎ±Î´Î¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î—Î›Î™Î”Î‘Î£': 'Î—Î»ÎµÎ¯Î±',
    'Î”Î—ÎœÎŸÎ£ Î£Î‘Î›Î‘ÎœÎ™ÎÎ‘Î£': 'Î‘Ï„Ï„Î¹ÎºÎ®',
    'Î”Î—ÎœÎŸÎ£ Î˜Î•Î¡ÎœÎŸÎ¥': 'Î‘Î¹Ï„Ï‰Î»Î¿Î±ÎºÎ±ÏÎ½Î±Î½Î¯Î±',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ Î”Î—ÎœÎ©Î ÎšÎ‘Î›Î‘ÎœÎ‘Î¤Î‘Î£ - ÎœÎ•Î£Î£Î—ÎÎ—Î£ & ÎšÎŸÎ™ÎÎŸÎ¤Î—Î¤Î©Î Î Î•Î¡Î™ÎŸÎ§Î—Î£ ÎšÎ‘Î›Î‘ÎœÎ‘Î¤Î‘Î£': 'ÎœÎµÏƒÏƒÎ·Î½Î¯Î±',
    'Î£Î¥ÎÎ”Î•Î£ÎœÎŸÎ£ Î¥Î”Î¡Î•Î¥Î£Î—Î£ ÎŸ.Î¤.Î‘. Î. Î¦Î˜Î™Î©Î¤Î™Î”Î‘Î£ Î‘Î ÎŸ Î Î—Î“Î•Î£ "ÎšÎ‘ÎÎ‘Î›Î™Î‘" Î Î¥Î¡Î“ÎŸÎ¥ Î¥Î Î‘Î¤Î—Î£': 'Î¦Î¸Î¹ÏÏ„Î¹Î´Î±',
    'ÎŸÎ¤Î‘ Î’\' Î’Î‘Î˜ÎœÎŸÎ¥ Î Î•Î¡Î™Î¦Î•Î¡Î•Î™Î‘ ÎÎŸÎ¤Î™ÎŸÎ¥ Î‘Î™Î“Î‘Î™ÎŸÎ¥': 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿'
}

def normalize_greek(text):
    """
    Normalizes a Greek string by converting to uppercase, removing accents,
    and stripping extra whitespace and punctuation.
    """
    if not isinstance(text, str):
        return ''
        
    text = text.upper().strip()
    
    # Define accent mappings
    replacements = {
        'Î†': 'Î‘', 'Îˆ': 'Î•', 'Î‰': 'Î—', 'ÎŠ': 'Î™', 'ÎŒ': 'ÎŸ', 'Î': 'Î¥', 'Î': 'Î©',
        'Îª': 'Î™', 'Î«': 'Î¥'
    }
    
    for accented, unaccented in replacements.items():
        text = text.replace(accented, unaccented)
        
    # Remove common punctuation and collapse whitespace
    text = re.sub(r'[\.\(\)-]', ' ', text) # Replace punctuation with a space
    text = re.sub(r'\s+', ' ', text).strip() # Collapse multiple spaces to one and strip again
    
    return text

@st.cache_data(ttl=3600, show_spinner="Analyzing Excel file...")
def load_and_analyze_excel_enhanced(excel_file):
    """Enhanced loading with comprehensive data analysis."""
    try:
        df = pd.read_excel(excel_file, sheet_name=0)
        


        st.write(f"ğŸ“Š Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ **{len(df):,}** Î³ÏÎ±Î¼Î¼Î­Ï‚ Î¼Îµ **{len(df.columns)}** ÏƒÏ„Î®Î»ÎµÏ‚")
        
        # Find project number column
        project_number_col = None
        for col_name in ['Î‘/Î‘', 'Î‘Î‘', 'A/A', 'AA', 'Project_ID', 'ID', 'Î‘Ï.']:
            if col_name in df.columns:
                project_number_col = col_name
                break
        
        if project_number_col is None:
            df.insert(0, 'Î‘/Î‘', range(1, len(df) + 1))
            project_number_col = 'Î‘/Î‘'
        
        # Clean data
        df = df.dropna(how='all')
        if project_number_col in df.columns:
            df = df.dropna(subset=[project_number_col])
        
        # Clean string columns
        string_columns = df.select_dtypes(include=['object']).columns
        for col in string_columns:
            df[col] = df[col].astype(str).str.strip()
            df[col] = df[col].replace(['nan', 'None', '', 'NaN'], pd.NA)
        
        # Find water utility column
        water_utility_col = None
        for col_name in ['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚', 'Î”Î•Î¥Î‘', 'Î¦Î¿ÏÎ­Î±Ï‚', 'Water_Utility']:
            if col_name in df.columns:
                water_utility_col = col_name
                break
        
        if water_utility_col is None:
            df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'] = 'Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚'
            water_utility_col = 'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'
        
        # Add prefecture mapping with debugging
        # Add prefecture mapping using the normalization function for robust matching
    
        # 1. Create a new column in your DataFrame with the normalized utility names
        df['normalized_utility'] = df[water_utility_col].apply(normalize_greek)
        
        # 2. Create a new, normalized dictionary for mapping
        normalized_map = {normalize_greek(k): v for k, v in DEYA_TO_PREFECTURE.items()}
        
        # 3. Perform the mapping using the normalized values
        df['ÎÎ¿Î¼ÏŒÏ‚'] = df['normalized_utility'].map(normalized_map)
        
        # Debug: Show unmapped DEYAs
        unmapped_deyas = df[df['ÎÎ¿Î¼ÏŒÏ‚'].isna()][water_utility_col].value_counts()
        if not unmapped_deyas.empty:
            st.warning("âš ï¸ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹ Ï€Î¿Ï… Î´ÎµÎ½ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¯ÏƒÏ„Î·ÎºÎ±Î½ ÏƒÎµ Î½Î¿Î¼Î¿ÏÏ‚:")
            for deya, count in unmapped_deyas.items():
                st.write(f"â€¢ **{deya}**: {count} Î­ÏÎ³Î±")
            
            # Try fuzzy matching for unmapped DEYAs
            st.info("ğŸ’¡ Î ÏÎ¿ÏƒÏ€Î±Î¸Ï Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ·...")
            
            additional_mappings = {}
            for unmapped_deya in unmapped_deyas.index:
                # Simple fuzzy matching logic
                deya_clean = unmapped_deya.upper().strip()
                
                # Check if it contains known city names
                city_mappings = {
                    'Î˜Î•Î£Î£Î‘Î›ÎŸÎÎ™Îš': 'Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·', 'Î‘Î˜Î—Î': 'Î‘Ï„Ï„Î¹ÎºÎ®', 'Î Î‘Î¤Î¡': 'Î‘Ï‡Î±ÎÎ±',
                    'Î’ÎŸÎ›ÎŸÎ£': 'ÎœÎ±Î³Î½Î·ÏƒÎ¯Î±', 'Î›Î‘Î¡Î™Î£': 'Î›Î¬ÏÎ¹ÏƒÎ±', 'Î™Î©Î‘ÎÎÎ™Î': 'Î™Ï‰Î¬Î½Î½Î¹Î½Î±',
                    'Î—Î¡Î‘ÎšÎ›Î•Î™': 'Î—ÏÎ¬ÎºÎ»ÎµÎ¹Î¿', 'Î§Î‘ÎÎ™': 'Î§Î±Î½Î¹Î¬', 'ÎšÎ‘Î’Î‘Î›': 'ÎšÎ±Î²Î¬Î»Î±',
                    'Î”Î¡Î‘Îœ': 'Î”ÏÎ¬Î¼Î±', 'ÎšÎŸÎœÎŸÎ¤Î™Î': 'Î¡Î¿Î´ÏŒÏ€Î·', 'ÎÎ‘ÎÎ˜': 'ÎÎ¬Î½Î¸Î·',
                    'Î‘Î›Î•ÎÎ‘ÎÎ”Î¡ÎŸÎ¥Î ÎŸÎ›': 'ÎˆÎ²ÏÎ¿Ï‚', 'Î£Î•Î¡Î¡': 'Î£Î­ÏÏÎµÏ‚', 'ÎšÎ•Î¡ÎšÎ¥Î¡': 'ÎšÎ­ÏÎºÏ…ÏÎ±'
                }
                
                for city_part, prefecture in city_mappings.items():
                    if city_part in deya_clean:
                        additional_mappings[unmapped_deya] = prefecture
                        break
            
            # Apply additional mappings
            if additional_mappings:
                st.success(f"âœ… Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¯Ï‡Î¹ÏƒÎ· {len(additional_mappings)} Î”Î•Î¥Î‘:")
                for deya, prefecture in additional_mappings.items():
                    st.write(f"â€¢ **{deya}** â†’ {prefecture}")
                
                # Update the dataframe
                for deya, prefecture in additional_mappings.items():
                    df.loc[df[water_utility_col] == deya, 'ÎÎ¿Î¼ÏŒÏ‚'] = prefecture
        
        # Fill remaining unmapped as 'Î†Î»Î»Î¿Ï‚'
        df['ÎÎ¿Î¼ÏŒÏ‚'] = df['ÎÎ¿Î¼ÏŒÏ‚'].fillna('Î†Î»Î»Î¿Ï‚')
        
        # Find or create region column
        region_col = None
        for col_name in ['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±', 'Region', 'Î ÎµÏÎ¹Î¿Ï‡Î®']:
            if col_name in df.columns:
                region_col = col_name
                break
        
        if region_col is None:
            # Create region mapping from prefectures
            df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'] = df['ÎÎ¿Î¼ÏŒÏ‚'].map(
                lambda x: GREEK_PREFECTURES_COORDS.get(x, {}).get('region', 'Î†Î»Î»Î·')
            )
            region_col = 'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'
        
        # Convert numeric columns
        potential_numeric_cols = []
        for col in df.columns:
            if any(keyword in str(col).lower() for keyword in 
                  ['Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'budget', 'ÎºÏŒÏƒÏ„Î¿Ï‚', 'cost', 'Ï€Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚', 'population', 'Ï‡ÏÏŒÎ½Î¿Ï‚', 'time', 'Î¼Î®Î½ÎµÏ‚', 'months']):
                potential_numeric_cols.append(col)

        # Force convert budget column specifically
        budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
        if budget_column_I in df.columns:
            # Clean the budget column - remove any non-numeric characters except decimal points
            df[budget_column_I] = df[budget_column_I].astype(str).str.replace(',', '').str.replace('â‚¬', '').str.replace(' ', '')
            df[budget_column_I] = pd.to_numeric(df[budget_column_I], errors='coerce')


        for col in potential_numeric_cols:
            if col in df.columns and col != budget_column_I:  # Don't double-convert
                df[col] = pd.to_numeric(df[col], errors='coerce')


        
        # Add project type column
        project_type_cols = ['Î•Î¯Î´Î¿Ï‚ ÎˆÏÎ³Î¿Ï…', 'Project_Type', 'Type', 'Î¤ÏÏ€Î¿Ï‚']
        for col_name in project_type_cols:
            if col_name in df.columns:
                df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'] = df[col_name].fillna('Î†Î»Î»Î¿')
                break
        else:
            df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'] = 'Î†Î»Î»Î¿'
        
        st.success(f"âœ… Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ! ÎˆÏÎ³Î±: **{len(df):,}**")
        
        return df
        
    except Exception as e:
        st.error(f"âŒ Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚: {e}")
        return None

def create_interactive_map_by_prefecture(df):
    """Create interactive map showing projects by prefecture (Î½Î¿Î¼ÏŒÏ‚)."""
    center_lat, center_lon = 39.0, 22.0
    
    m = folium.Map(
        location=[center_lat, center_lon], 
        zoom_start=6, 
        tiles='OpenStreetMap'
    )
    
    # Group by prefecture
    if 'ÎÎ¿Î¼ÏŒÏ‚' in df.columns:
        # Ensure required columns exist for aggregation
        agg_dict = {'Î‘/Î‘': 'count', 'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique'}
        
        # Add column I budget specifically - CHECK IF IT EXISTS FIRST
        budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
        budget_cols = [col for col in df.columns if 'Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in str(col).lower()]
        if budget_column_I in df.columns:
            # Check if the column has numeric data
            numeric_budget_data = df[budget_column_I].dropna()
            if len(numeric_budget_data) > 0:
                agg_dict[budget_column_I] = ['sum', 'mean', 'count']
                st.write(f"âœ… Adding {budget_column_I} to aggregation. Sample values: {numeric_budget_data.head().tolist()}")
            else:
                st.warning(f"âš ï¸ {budget_column_I} has no numeric data!")
        else:
            st.error(f"âŒ {budget_column_I} not found in DataFrame!")
            # Try to find similar columns
            budget_cols = [col for col in df.columns if 'Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in str(col).lower()]
            st.write(f"Available budget columns: {budget_cols}")
            if budget_cols:
                budget_column_I = budget_cols[0]  # Use the first available budget column
                agg_dict[budget_column_I] = ['sum', 'mean', 'count']
                st.info(f"Using alternative budget column: {budget_column_I}")

        prefecture_data = df.groupby('ÎÎ¿Î¼ÏŒÏ‚').agg(agg_dict).round(0)
        
        # Flatten column names
        new_cols = {}
        new_cols['Î‘/Î‘_count'] = 'ÎˆÏÎ³Î±'
        new_cols['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚_nunique'] = 'Î”Î•Î¥Î‘_Count'
        
        # Add column I budget columns
        if budget_column_I in df.columns:
            new_cols[f'{budget_column_I}_sum'] = 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚_Î ÏÎ¿Ï‹Ï€_Î™'
            new_cols[f'{budget_column_I}_mean'] = 'ÎœÎ­ÏƒÎ¿Ï‚_Î ÏÎ¿Ï‹Ï€_Î™'
            new_cols[f'{budget_column_I}_count'] = 'ÎˆÏÎ³Î±_Î¼Îµ_Î ÏÎ¿Ï‹Ï€_Î™'
        
        for col in budget_cols:
            if col != budget_column_I:
                new_cols[f'{col}_sum'] = f'{col}_sum'
                new_cols[f'{col}_mean'] = f'{col}_mean'
                
        prefecture_data.columns = ['_'.join(col).strip() for col in prefecture_data.columns.values]
        prefecture_data = prefecture_data.rename(columns=new_cols)

        for prefecture, data in prefecture_data.iterrows():
            if prefecture in GREEK_PREFECTURES_COORDS and data['ÎˆÏÎ³Î±'] > 0:
                coords = GREEK_PREFECTURES_COORDS[prefecture]
                
                # --- Pre-calculate financial data for use in multiple sections ---
                # Correctly reference the renamed budget column
                budget_sum_col_name = 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚_Î ÏÎ¿Ï‹Ï€_Î™'
                if budget_sum_col_name in data.index:
                    total_budget = data[budget_sum_col_name]
                else:
                    total_budget = 0

                # 1. Header Section
                popup_parts = [
                    f'<div style="font-family: Arial; min-width: 400px; max-width: 500px; padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">',
                    f'<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">',
                    f'<h3 style="margin: 0; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 8px; display: flex; align-items: center;">',
                    f'<span style="font-size: 24px; margin-right: 10px;">ğŸ›ï¸</span>',
                    f'{prefecture}',
                    f'<span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: auto;">{coords["region"]}</span>',
                    f'</h3>',
                    f'<div style="display: flex; justify-content: space-around; margin: 15px 0; padding: 10px; background: #ecf0f1; border-radius: 8px;">',
                    f'<div style="text-align: center;">',
                    f'<span style="font-size: 28px; font-weight: bold; color: #e74c3c;">{int(data["ÎˆÏÎ³Î±"])}</span>',
                    f'<div style="color: #7f8c8d; font-size: 12px;">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏÎ³Î±</div>',
                    f'</div>',
                    f'<div style="text-align: center;">',
                    f'<span style="font-size: 28px; font-weight: bold; color: #27ae60;">â‚¬{total_budget:,.0f}</span>',
                    f'<div style="color: #7f8c8d; font-size: 12px;">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€.</div>',
                    f'</div>',
                    f'<div style="text-align: center;">',
                    f'<span style="font-size: 28px; font-weight: bold; color: #f39c12;">{int(data["Î”Î•Î¥Î‘_Count"])}</span>',
                    f'<div style="color: #7f8c8d; font-size: 12px;">Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹</div>',
                    f'</div>',
                    f'</div>',
                    f'</div>'
                ]

                # --- Add example projects section ---
                projects_in_prefecture = df[df['ÎÎ¿Î¼ÏŒÏ‚'] == prefecture]
                if not projects_in_prefecture.empty:
                    # Find title and budget columns
                    title_col = next((col for col in projects_in_prefecture.columns if 'Ï„Î¯Ï„Î»Î¿Ï‚' in col.lower()), 'Î¤Î¯Ï„Î»Î¿Ï‚ ÎˆÏÎ³Î¿Ï…')
                    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
                    
                    # Sort by budget if column exists, otherwise take first projects
                    if budget_col in projects_in_prefecture.columns:
                        top_projects = projects_in_prefecture.nlargest(3, budget_col)
                    else:
                        top_projects = projects_in_prefecture.head(3)
                    
                    project_list_html = []
                    for _, project in top_projects.iterrows():
                        title = project.get(title_col, 'N/A')
                        budget_val = f"â‚¬{project.get(budget_col, 0):,.0f}" if budget_col in project else "N/A"
                        project_list_html.append(f'<li style="margin-bottom: 5px;"><strong>{title[:60]}...</strong><br><small style="color: #27ae60;">{budget_val}</small></li>')

                    if project_list_html:
                        popup_parts.extend([
                            f'<div style="background: #f9f9f9; padding: 12px; border-radius: 8px; margin-top: 15px;">',
                            f'<h4 style="margin: 0 0 10px 0; color: #34495e; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;">ğŸ—ï¸ Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± ÎˆÏÎ³Ï‰Î½</h4>',
                            f'<ul style="list-style-type: none; padding-left: 0; margin: 0;">',
                            ''.join(project_list_html),
                            f'</ul>',
                            f'</div>'
                        ])

                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #27ae60; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ’°</span>ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</h4>')

                budget_col_sum = 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚_Î ÏÎ¿Ï‹Ï€_Î™'  # This refers to column I budget
                budget_col_mean = 'ÎœÎ­ÏƒÎ¿Ï‚_Î ÏÎ¿Ï‹Ï€_Î™'

                if budget_col_sum in data and data[budget_col_sum] > 0:
                    total_budget = data[budget_col_sum]
                    avg_budget = data[budget_col_mean] if budget_col_mean in data and pd.notna(data[budget_col_mean]) else 0
                    
                    popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                    popup_parts.append(f'<span><strong>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î /Î¥:</strong></span>')
                    popup_parts.append(f'<span style="color: #27ae60; font-weight: bold;">â‚¬{total_budget:,.0f}</span>')
                    popup_parts.append(f'</div>')
                    
                    if avg_budget > 0:
                        popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                        popup_parts.append(f'<span><strong>ÎœÎ­ÏƒÎ¿Ï‚ Î /Î¥:</strong></span>')
                        popup_parts.append(f'<span style="color: #f39c12; font-weight: bold;">â‚¬{avg_budget:,.0f}</span>')
                        popup_parts.append(f'</div>')
                    
                    # NEW CODE: Budget per Municipality/Region calculation
                    prefecture_df = df[df['ÎÎ¿Î¼ÏŒÏ‚'] == prefecture]
                    
                    # Find budget column (column I)
                    budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
                    
                    # Check if we have municipality/region data and budget data
                    if budget_column_I in prefecture_df.columns:
                        # Group by municipality (Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Ï‚) to calculate budget per region
                        municipality_budget = prefecture_df.groupby('Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚')[budget_column_I].agg(['sum', 'count', 'mean']).reset_index()
                        municipality_budget = municipality_budget[municipality_budget['sum'] > 0]  # Only municipalities with budget data
                        
                        if not municipality_budget.empty:
                            # Calculate total municipalities with budget data
                            municipalities_with_budget = len(municipality_budget)
                            avg_budget_per_municipality = municipality_budget['sum'].mean()
                            
                            popup_parts.append(f'<div style="margin-top: 10px; border-top: 1px solid #ecf0f1; padding-top: 8px;">')
                            popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                            popup_parts.append(f'<span><strong>Î”Î®Î¼Î¿Î¹ Î¼Îµ Î /Î¥:</strong></span>')
                            popup_parts.append(f'<span style="color: #9b59b6; font-weight: bold;">{municipalities_with_budget}</span>')
                            popup_parts.append(f'</div>')
                            
                            popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                            popup_parts.append(f'<span><strong>ÎœÎ­ÏƒÎ¿Ï‚ Î /Î¥/Î”Î®Î¼Î¿:</strong></span>')
                            popup_parts.append(f'<span style="color: #8e44ad; font-weight: bold;">â‚¬{avg_budget_per_municipality:,.0f}</span>')
                            popup_parts.append(f'</div>')
                            
                            # Show top 3 municipalities by budget
                            top_municipalities = municipality_budget.nlargest(3, 'sum')
                            popup_parts.append(f'<div style="margin-top: 8px;">')
                            popup_parts.append(f'<div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">Top 3 Î”Î®Î¼Î¿Î¹ (Î /Î¥):</div>')
                            
                            for idx, row in top_municipalities.iterrows():
                                municipality_name = row['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚']
                                municipality_budget_amount = row['sum']
                                municipality_projects = row['count']
                                
                                # Truncate long municipality names
                                display_name = municipality_name[:25] + "..." if len(municipality_name) > 25 else municipality_name
                                
                                popup_parts.append(f'<div style="font-size: 10px; margin: 2px 0; padding: 3px; background: #f8f9fa; border-radius: 3px;">')
                                popup_parts.append(f'<strong>{display_name}</strong><br>')
                                popup_parts.append(f'â‚¬{municipality_budget_amount:,.0f} ({municipality_projects} Î­ÏÎ³Î±)')
                                popup_parts.append(f'</div>')
                            
                            popup_parts.append(f'</div>')
                            popup_parts.append(f'</div>')
                else:
                    popup_parts.append('<div style="text-align: center; color: #7f8c8d; font-size: 12px; padding: 10px 0;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±.</div>')

                popup_parts.append('</div>')

                # 3. Project Progress Analytics
                prefecture_df = df[df['ÎÎ¿Î¼ÏŒÏ‚'] == prefecture]
                progress_col = next((col for col in ['Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚', 'Progress', 'Completion'] if col in prefecture_df.columns), None)
                status_col = next((col for col in ['Î£Ï„Î¬Î´Î¹Î¿', 'Status', 'Phase', 'Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·'] if col in prefecture_df.columns), None)

                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #8e44ad; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ“ˆ</span>Î ÏÏŒÎ¿Î´Î¿Ï‚ ÎˆÏÎ³Ï‰Î½</h4>')

                if progress_col:
                    # Extract completion percentages
                    completion_data = prefecture_df[progress_col].dropna()
                    completion_values = []
                    for comp in completion_data:
                        if isinstance(comp, str):
                            percentages = re.findall(r'(\d+)%', comp)
                            if percentages:
                                completion_values.extend([int(p) for p in percentages])
                    
                    if completion_values:
                        avg_completion = np.mean(completion_values)
                        completed = sum(1 for v in completion_values if v >= 100)
                        in_progress = sum(1 for v in completion_values if 50 <= v < 100)
                        early_stage = sum(1 for v in completion_values if v < 50)
                        
                        popup_parts.append(f'<div style="margin-bottom: 10px; text-align: center;">')
                        popup_parts.append(f'<div style="font-size: 24px; color: #8e44ad; font-weight: bold;">{avg_completion:.1f}%</div>')
                        popup_parts.append(f'<div style="color: #7f8c8d; font-size: 12px;">ÎœÎ­ÏƒÎ· ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·</div>')
                        popup_parts.append(f'</div>')
                        
                        # Progress bar
                        popup_parts.append(f'<div style="background: #ecf0f1; border-radius: 10px; height: 8px; margin: 10px 0;">')
                        popup_parts.append(f'<div style="background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60); width: {avg_completion}%; height: 100%; border-radius: 10px;"></div>')
                        popup_parts.append(f'</div>')
                        
                        popup_parts.append('<div style="display: flex; justify-content: space-between; font-size: 11px; margin-top: 8px;">')
                        popup_parts.append(f'<span>âœ… ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·: {completed}</span>')
                        popup_parts.append(f'<span>ğŸ”„ Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·: {in_progress}</span>')
                        popup_parts.append(f'<span>ğŸ”¨ ÎˆÎ½Î±ÏÎ¾Î·: {early_stage}</span>')
                        popup_parts.append('</div>')

                if status_col:
                    status_counts = prefecture_df[status_col].value_counts().head(3)
                    if not status_counts.empty:
                        popup_parts.append('<div style="margin-top: 10px; border-top: 1px solid #ecf0f1; padding-top: 8px;">')
                        popup_parts.append('<div style="font-size: 12px; color: #7f8c8d;">ÎšÏÏÎ¹Î± Î£Ï„Î¬Î´Î¹Î±:</div>')
                        for status, count in status_counts.items():
                            popup_parts.append(f'<div style="font-size: 11px;">â€¢ {status}: {count}</div>')
                        popup_parts.append('</div>')

                popup_parts.append('</div>')

                popup_parts.append('</div>')

                # 4. Project Categories
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #e67e22; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ—ï¸</span>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ ÎˆÏÎ³Ï‰Î½</h4>')

                if 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…' in prefecture_df.columns:
                    budget_col_name = next((col for col in prefecture_df.columns if 'Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in col), None)
                    category_counts = prefecture_df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'].value_counts().head(4)

                    if not category_counts.empty:
                        popup_parts.append('<ul style="list-style: none; padding: 0; margin: 0; font-size: 12px;">')
                        for category, count in category_counts.items():
                            category_budget = 0
                            if budget_col_name:
                                category_budget = prefecture_df[prefecture_df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'] == category][budget_col_name].sum()
                            
                            popup_parts.append(f'<li style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #ecf0f1;">')
                            popup_parts.append(f'<span>{str(category)} ({count})</span>')
                            popup_parts.append(f'<strong style="color: #27ae60;">â‚¬{category_budget:,.0f}</strong>')
                            popup_parts.append(f'</li>')
                        popup_parts.append('</ul>')

                # Priority distribution if available
                priority_col = next((col for col in prefecture_df.columns if 'Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±' in str(col).lower()), None)
                if priority_col:
                    priority_counts = prefecture_df[priority_col].value_counts().head(3)
                    if not priority_counts.empty:
                        popup_parts.append('<div style="margin-top: 10px; border-top: 1px solid #ecf0f1; padding-top: 8px;">')
                        popup_parts.append('<div style="font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„ÎµÏ‚:</div>')
                        popup_parts.append('<div style="display: flex; gap: 8px; font-size: 10px;">')
                        
                        priority_colors = {'1Î·': '#e74c3c', '2Î·': '#f39c12', '3Î·': '#27ae60'}
                        for priority, count in priority_counts.items():
                            color = priority_colors.get(str(priority)[:2], '#95a5a6')
                            popup_parts.append(f'<span style="background: {color}; color: white; padding: 2px 6px; border-radius: 12px;">{priority}: {count}</span>')
                        
                        popup_parts.append('</div>')
                        popup_parts.append('</div>')

                popup_parts.append('</div>')

                # Demographics & Impact Section
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #16a085; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ‘¥</span>Î”Î·Î¼Î¿Î³ÏÎ±Ï†Î¹ÎºÎ¬ & Î•Ï€Î¯Î´ÏÎ±ÏƒÎ·</h4>')

                # NEW CODE: Budget efficiency per region
                budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
                if budget_column_I in prefecture_df.columns:
                    budget_data = prefecture_df[budget_column_I].dropna()
                    if not budget_data.empty:
                        total_prefecture_budget = budget_data.sum()
                        num_municipalities = len(prefecture_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique())
                        budget_per_municipality_avg = total_prefecture_budget / num_municipalities if num_municipalities > 0 else 0
                        
                        popup_parts.append(f'<div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 6px;">')
                        popup_parts.append(f'<div style="font-size: 11px; color: #16a085; text-align: center;">')
                        popup_parts.append(f'ğŸ’° <strong>ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® Î‘Ï€Î¿Î´Î¿Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±</strong><br>')
                        popup_parts.append(f'â‚¬{budget_per_municipality_avg:,.0f} Î¼Î­ÏƒÎ¿Ï‚ Î /Î¥ Î±Î½Î¬ Î´Î®Î¼Î¿<br>')
                        popup_parts.append(f'{num_municipalities} ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Î´Î®Î¼Î¿Î¹/Ï†Î¿ÏÎµÎ¯Ï‚')
                        popup_parts.append(f'</div>')
                        popup_parts.append(f'</div>')

                popup_parts.append('</div>')

                # 5. Timeline Information
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #3498db; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ“…</span>Î§ÏÎ¿Î½Î¿Î´Î¹Î¬Î³ÏÎ±Î¼Î¼Î±</h4>')

                # Timeline analysis
                time_cols = [col for col in prefecture_df.columns if any(word in str(col).lower() for word in ['Ï‡ÏÏŒÎ½Î¿Ï‚', 'Î¼Î®Î½ÎµÏ‚', 'time', 'months'])]
                date_cols = [col for col in prefecture_df.columns if 'Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯' in str(col).lower()]

                if time_cols:
                    time_data = prefecture_df[time_cols[0]].dropna()
                    if len(time_data) > 0:
                        avg_duration = time_data.mean() if pd.api.types.is_numeric_dtype(time_data) else 0
                        
                        if avg_duration > 0:
                            popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                            popup_parts.append(f'<span><strong>ÎœÎ­ÏƒÎ· Î”Î¹Î¬ÏÎºÎµÎ¹Î±:</strong></span>')
                            popup_parts.append(f'<span style="color: #3498db; font-weight: bold;">{avg_duration:.1f} Î¼Î®Î½ÎµÏ‚</span>')
                            popup_parts.append(f'</div>')
                        
                        # Duration categories
                        if pd.api.types.is_numeric_dtype(time_data):
                            short_term = len(time_data[time_data <= 12])
                            medium_term = len(time_data[(time_data > 12) & (time_data <= 36)])
                            long_term = len(time_data[time_data > 36])
                            
                            popup_parts.append('<div style="display: flex; justify-content: space-between; font-size: 11px; margin-top: 8px;">')
                            popup_parts.append(f'<span>âš¡ Î’ÏÎ±Ï‡Ï…Ï€ÏÏŒÎ¸ÎµÏƒÎ¼Î±: {short_term}</span>')
                            popup_parts.append(f'<span>ğŸ”„ ÎœÎµÏƒÎ¿Ï€ÏÏŒÎ¸ÎµÏƒÎ¼Î±: {medium_term}</span>')
                            popup_parts.append(f'<span>â³ ÎœÎ±ÎºÏÎ¿Ï€ÏÏŒÎ¸ÎµÏƒÎ¼Î±: {long_term}</span>')
                            popup_parts.append('</div>')

                # Current year projects
                from datetime import datetime
                current_year = datetime.now().year

                if date_cols:
                    dates_data = prefecture_df[date_cols[0]].dropna()
                    current_year_projects = 0
                    
                    for date_str in dates_data:
                        if isinstance(date_str, str) and str(current_year) in date_str:
                            current_year_projects += 1
                    
                    if current_year_projects > 0:
                        popup_parts.append(f'<div style="margin-top: 10px; padding: 8px; background: #e8f6ff; border-radius: 6px; text-align: center;">')
                        popup_parts.append(f'<span style="color: #3498db; font-weight: bold;">ğŸš€ ÎˆÏÎ³Î± {current_year}: {current_year_projects}</span>')
                        popup_parts.append(f'</div>')

                popup_parts.append('</div>')

                # 6. Demographics & Impact Section
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #16a085; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ‘¥</span>Î”Î·Î¼Î¿Î³ÏÎ±Ï†Î¹ÎºÎ¬ & Î•Ï€Î¯Î´ÏÎ±ÏƒÎ·</h4>')

                # Population served
                pop_cols = [col for col in prefecture_df.columns if 'Ï€Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚' in str(col).lower() and prefecture_df[col].dtype in ['int64', 'float64']]
                if pop_cols:
                    pop_data = prefecture_df[pop_cols[0]].dropna()
                    if len(pop_data) > 0:
                        total_population = pop_data.sum()
                        avg_population = pop_data.mean()
                        
                        popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                        popup_parts.append(f'<span><strong>Î£Ï…Î½. Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚:</strong></span>')
                        popup_parts.append(f'<span style="color: #16a085; font-weight: bold;">{total_population:,.0f}</span>')
                        popup_parts.append(f'</div>')
                        
                        popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                        popup_parts.append(f'<span><strong>ÎœÎ­ÏƒÎ¿Ï‚/ÎˆÏÎ³Î¿:</strong></span>')
                        popup_parts.append(f'<span style="color: #f39c12; font-weight: bold;">{avg_population:,.0f}</span>')
                        popup_parts.append(f'</div>')

                # DEYA count
                deya_count = len(prefecture_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique())
                popup_parts.append(f'<div style="display: flex; justify-content: space-between; margin: 8px 0;">')
                popup_parts.append(f'<span><strong>Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹:</strong></span>')
                popup_parts.append(f'<span style="color: #9b59b6; font-weight: bold;">{deya_count}</span>')
                popup_parts.append(f'</div>')

                # Environmental impact indicators
                popup_parts.append('<div style="margin-top: 10px; padding: 8px; background: #e8f8f5; border-radius: 6px;">')
                popup_parts.append('<div style="font-size: 11px; color: #16a085; text-align: center;">')
                popup_parts.append(f'ğŸŒ Î ÎµÏÎ¹Î²Î±Î»Î»Î¿Î½Ï„Î¹ÎºÎ® Î•Ï€Î¯Î´ÏÎ±ÏƒÎ·: {len(prefecture_df)} Î­ÏÎ³Î±')
                popup_parts.append('<br>ğŸ’§ Î’ÎµÎ»Ï„Î¯Ï‰ÏƒÎ· Ï€Î¿Î¹ÏŒÏ„Î·Ï„Î±Ï‚ Î½ÎµÏÎ¿Ï & Ï…Î³ÎµÎ¯Î±Ï‚')
                popup_parts.append('</div>')
                popup_parts.append('</div>')

                popup_parts.append('</div>')

                # Enhanced Information Section (instead of interactive buttons)
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #c0392b; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ“‹</span>Î ÏÏŒÏƒÎ¸ÎµÏ„ÎµÏ‚ Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚</h4>')

                # Quick stats grid
                popup_parts.append('<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">')

                # Total projects in region
                region_projects = len(df[df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'] == coords['region']])
                popup_parts.append(f'<div style="background: #ecf0f1; padding: 8px; border-radius: 6px; text-align: center;">')
                popup_parts.append(f'<strong>ğŸ“ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±</strong><br>{coords["region"]}<br>ÎˆÏÎ³Î±: {region_projects}')
                popup_parts.append(f'</div>')

                # Prefecture rank
                prefecture_counts = df['ÎÎ¿Î¼ÏŒÏ‚'].value_counts()
                prefecture_rank = list(prefecture_counts.index).index(prefecture) + 1 if prefecture in prefecture_counts.index else 0
                popup_parts.append(f'<div style="background: #ecf0f1; padding: 8px; border-radius: 6px; text-align: center;">')
                popup_parts.append(f'<strong>ğŸ† ÎšÎ±Ï„Î¬Ï„Î±Î¾Î·</strong><br>#{prefecture_rank}<br>Î±Ï€ÏŒ {len(prefecture_counts)} Î½Î¿Î¼Î¿ÏÏ‚')
                popup_parts.append(f'</div>')

                # Budget per capita if available
                if 'total_population' in locals() and total_population > 0 and budget_col_sum and data[budget_col_sum] > 0:
                    budget_per_capita = data[budget_col_sum] / total_population
                    popup_parts.append(f'<div style="background: #ecf0f1; padding: 8px; border-radius: 6px; text-align: center;">')
                    popup_parts.append(f'<strong>ğŸ’° Î /Î¥ Î±Î½Î¬ ÎºÎ¬Ï„Î¿Î¹ÎºÎ¿</strong><br>â‚¬{budget_per_capita:.0f}')
                    popup_parts.append(f'</div>')

                # Project density
                popup_parts.append(f'<div style="background: #ecf0f1; padding: 8px; border-radius: 6px; text-align: center;">')
                popup_parts.append(f'<strong>ğŸ¯ Î Ï…ÎºÎ½ÏŒÏ„Î·Ï„Î±</strong><br>{int(data["ÎˆÏÎ³Î±"])}/{deya_count} Î”Î•Î¥Î‘')
                popup_parts.append(f'</div>')

                popup_parts.append('</div>')

                # Note about clicking
                popup_parts.append('<div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">')
                popup_parts.append('<div style="font-size: 10px; color: #856404;">')
                popup_parts.append('<strong>ğŸ’¡ Î£Ï…Î¼Î²Î¿Ï…Î»Î®:</strong> ÎšÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº ÏƒÏ„Î¿Î½ Ï‡Î¬ÏÏ„Î· Î³Î¹Î± Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÏ„Îµ Î¬Î»Î»Î¿ Î½Î¿Î¼ÏŒ ÎºÎ±Î¹ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Î¿Ï….')
                popup_parts.append('</div>')
                popup_parts.append('</div>')

                popup_parts.append('</div>')

                # 8. Visual Performance Indicators
                popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #2c3e50; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ“Š</span>Î”ÎµÎ¯ÎºÏ„ÎµÏ‚ Î‘Ï€ÏŒÎ´Î¿ÏƒÎ·Ï‚</h4>')

                # Heuristic performance score calculation
                score = 50  # Base score
                factors = []

                avg_completion = np.mean([int(p) for p in re.findall(r'(\d+)%', ' '.join(prefecture_df[progress_col].dropna().astype(str)))]) if progress_col and re.findall(r'(\d+)%', ' '.join(prefecture_df[progress_col].dropna().astype(str))) else 0
                if avg_completion > 75: score += 20; factors.append('âœ… Î¥ÏˆÎ·Î»Î® Ï€ÏÏŒÎ¿Î´Î¿Ï‚')
                elif avg_completion > 40: score += 10; factors.append('ğŸ‘ ÎšÎ±Î»Î® Ï€ÏÏŒÎ¿Î´Î¿Ï‚')
                else: score -= 5; factors.append('â³ Î§Î±Î¼Î·Î»Î® Ï€ÏÏŒÎ¿Î´Î¿Ï‚')

                if budget_col_sum and data[budget_col_sum] > 10000000: score += 10; factors.append('ğŸ’° ÎœÎµÎ³Î¬Î»Î¿Ï‚ Î /Î¥')
                if len(prefecture_df) > 15: score += 10; factors.append('ğŸ“ˆ Î Î¿Î»Î»Î¬ Î­ÏÎ³Î±')
                else: score -= 5

                score = max(0, min(100, score)) # Clamp score between 0 and 100
                
                score_color = '#27ae60' if score > 70 else ('#f39c12' if score > 40 else '#e74c3c')

                # Gauge meter
                popup_parts.append(f'<div style="text-align: center; margin-bottom: 10px;">')
                popup_parts.append(f'<div style="font-size: 28px; font-weight: bold; color: {score_color};">{score}/100</div>')
                popup_parts.append(f'<div style="background: #ecf0f1; border-radius: 10px; height: 10px; margin: 5px 0;">')
                popup_parts.append(f'<div style="background: {score_color}; width: {score}%; height: 100%; border-radius: 10px;"></div>')
                popup_parts.append(f'</div>')
                popup_parts.append(f'</div>')

                # Score factors
                if factors:
                    popup_parts.append('<div style="font-size: 11px; text-align: center; color: #7f8c8d;">')
                    popup_parts.append(' &bull; '.join(factors))
                    popup_parts.append('</div>')

                popup_parts.append('</div>')

                # Regional Budget Breakdown
                budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
                if budget_column_I in prefecture_df.columns:
                    popup_parts.append('<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">')
                    popup_parts.append('<h4 style="margin: 0 0 10px 0; color: #2c3e50; display: flex; align-items: center;"><span style="margin-right: 8px;">ğŸ›ï¸</span>ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï Î±Î½Î¬ Î”Î®Î¼Î¿</h4>')
                    
                    # Calculate budget distribution by municipality
                    municipality_stats = prefecture_df.groupby('Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚')[budget_column_I].agg(['sum', 'count']).reset_index()
                    municipality_stats = municipality_stats[municipality_stats['sum'] > 0]
                    municipality_stats = municipality_stats.sort_values('sum', ascending=False)
                    
                    if not municipality_stats.empty:
                        total_budget_in_prefecture = municipality_stats['sum'].sum()
                        
                        popup_parts.append('<div style="max-height: 120px; overflow-y: auto; font-size: 11px;">')
                        for idx, row in municipality_stats.head(5).iterrows():  # Show top 5
                            municipality = row['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚']
                            budget = row['sum']
                            projects = row['count']
                            percentage = (budget / total_budget_in_prefecture) * 100
                            
                            # Truncate name for display
                            display_name = municipality[:30] + "..." if len(municipality) > 30 else municipality
                            
                            popup_parts.append(f'<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-left: 4px solid #3498db; border-radius: 3px;">')
                            popup_parts.append(f'<strong>{display_name}</strong><br>')
                            popup_parts.append(f'â‚¬{budget:,.0f} ({percentage:.1f}%) - {projects} Î­ÏÎ³Î±')
                            popup_parts.append(f'</div>')
                        
                        popup_parts.append('</div>')
                        
                        if len(municipality_stats) > 5:
                            popup_parts.append(f'<div style="text-align: center; font-size: 10px; color: #7f8c8d; margin-top: 5px;">...ÎºÎ±Î¹ {len(municipality_stats) - 5} Î±ÎºÏŒÎ¼Î· Î´Î®Î¼Î¿Î¹</div>')
                    
                    popup_parts.append('</div>')

                popup_parts.append('</div>')
                popup_text = ''.join(popup_parts)
                
                # Circle size based on projects (square root scale for better visibility)
                radius = max(8, min(int(np.sqrt(data['ÎˆÏÎ³Î±']) * 4), 40))
                
                folium.CircleMarker(
                    location=[coords['lat'], coords['lon']],
                    radius=radius,
                    popup=folium.Popup(popup_text, max_width=520, max_height=600),
                    color=coords['color'],
                    fillColor=coords['color'],
                    fillOpacity=0.7,
                    weight=3,
                    tooltip=f'{prefecture}: {int(data["ÎˆÏÎ³Î±"])} Î­ÏÎ³Î±'
                ).add_to(m)
                
                # Add project count label inside the circle
                folium.Marker(
                    location=[coords['lat'], coords['lon']],
                    icon=folium.DivIcon(
                        html=f'<div style="color: white; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); font-size: 12px;">{int(data["ÎˆÏÎ³Î±"])}</div>',
                        icon_size=(25, 25),
                        icon_anchor=(12, 12)
                    )
                ).add_to(m)
    
    # Enhanced legend with more regions
    legend_html = """
    <div style="position: fixed; 
                bottom: 50px; left: 50px; width: 320px; height: 240px; 
                background-color: white; border:3px solid grey; z-index:9999; 
                font-size:11px; padding: 12px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
    <h4 style="margin-top: 0; color: #333; text-align: center;">ğŸ—ºï¸ Î§Î¬ÏÏ„Î·Ï‚ ÎˆÏÎ³Ï‰Î½ Î±Î½Î¬ ÎÎ¿Î¼ÏŒ</h4>
    <hr style="margin: 8px 0;">
    <div style="columns: 2; column-gap: 15px;">
    <p><i class="fa fa-circle" style="color:#FF6B6B"></i> Î‘Î½Î±Ï„. ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± - Î˜ÏÎ¬ÎºÎ·</p>
    <p><i class="fa fa-circle" style="color:#4ECDC4"></i> ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±</p>
    <p><i class="fa fa-circle" style="color:#45B7D1"></i> Î‘Ï„Ï„Î¹ÎºÎ®</p>
    <p><i class="fa fa-circle" style="color:#96CEB4"></i> Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±</p>
    <p><i class="fa fa-circle" style="color:#FFEAA7"></i> Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±</p>
    <p><i class="fa fa-circle" style="color:#DDA0DD"></i> Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±</p>
    <p><i class="fa fa-circle" style="color:#98D8C8"></i> Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚</p>
    <p><i class="fa fa-circle" style="color:#F7DC6F"></i> Î™ÏŒÎ½Î¹Î± Î½Î·ÏƒÎ¹Î¬</p>
    <p><i class="fa fa-circle" style="color:#BB8FCE"></i> ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿</p>
    <p><i class="fa fa-circle" style="color:#85C1E9"></i> Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿</p>
    <p><i class="fa fa-circle" style="color:#F8C471"></i> ÎšÏÎ®Ï„Î·</p>
    <p><i class="fa fa-circle" style="color:#82E0AA"></i> Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚</p>
    </div>
    <hr style="margin: 8px 0;">
    <p style="text-align: center; font-size: 10px; color: #666;">
    <strong>ÎœÎ­Î³ÎµÎ¸Î¿Ï‚ ÎºÏÎºÎ»Î¿Ï…</strong> = Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î­ÏÎ³Ï‰Î½ Î±Î½Î¬ Î½Î¿Î¼ÏŒ<br>
    <strong>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚</strong> = Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î­ÏÎ³Î± Î½Î¿Î¼Î¿Ï
    </p>
    </div>
    """
    m.get_root().html.add_child(folium.Element(legend_html))
    
    return m

def create_interactive_charts(df, selected_region=None, selected_prefecture=None):
    """Create interactive Plotly charts."""
    
    # Apply filters
    filtered_df = df.copy()
    
    if selected_region and selected_region != 'ÎŒÎ»ÎµÏ‚':
        filtered_df = filtered_df[filtered_df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'] == selected_region]
    
    if selected_prefecture and selected_prefecture != 'ÎŒÎ»Î¿Î¹':
        filtered_df = filtered_df[filtered_df['ÎÎ¿Î¼ÏŒÏ‚'] == selected_prefecture]
    
    if len(filtered_df) == 0:
        st.warning("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­ÏÎ³Î± Î³Î¹Î± Ï„Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±.")
        return
    
    # --- Main Content Area ---
    st.header("ğŸ—ºï¸ Î“ÎµÎ½Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ ÎˆÏÎ³Ï‰Î½")
    
    # Create and display the map
    interactive_map = create_interactive_map_by_prefecture(df)
    map_data = st_folium(interactive_map, width=1200, height=600, key="charts_map")

    # Store the clicked prefecture
    if map_data and map_data['last_object_clicked_popup']:
        popup_html = map_data['last_object_clicked_popup']
        # Extract prefecture name from the popup's HTML content
        match = re.search(r'ğŸ“ (.*?)</h4', popup_html)
        if match:
            st.session_state['selected_prefecture_on_map'] = match.group(1).strip()
    
    # Enhanced metrics row
    col1, col2, col3, col4, col5, col6 = st.columns(6)
    
    with col1:
        st.metric("ğŸ—ï¸ ÎˆÏÎ³Î±", f"{len(filtered_df):,}")
    
    with col2:
        regions_count = len(filtered_df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'].unique())
        st.metric("ğŸ—ºï¸ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹ÎµÏ‚", regions_count)
    
    with col3:
        prefectures_count = len(filtered_df['ÎÎ¿Î¼ÏŒÏ‚'].unique())
        st.metric("ğŸ›ï¸ ÎÎ¿Î¼Î¿Î¯", prefectures_count)
    
    with col4:
        deya_count = len(filtered_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique())
        st.metric("ğŸ¢ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹", deya_count)
    
    with col5:
        # Use the specific budget column
        budget_column_I = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
        if budget_column_I in filtered_df.columns and pd.api.types.is_numeric_dtype(filtered_df[budget_column_I]):
            total_budget = filtered_df[budget_column_I].sum() / 1_000_000_000
            st.metric("ğŸ’° Î£Ï…Î½. Î ÏÎ¿Ï‹Ï€.", f"{total_budget:.2f}B â‚¬")
        else:
            st.metric("ğŸ’° Î£Ï…Î½. Î ÏÎ¿Ï‹Ï€.", "N/A")
    
    with col6:
        # Use a specific population column
        population_col = 'Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚'
        if population_col in filtered_df.columns and pd.api.types.is_numeric_dtype(filtered_df[population_col]):
            total_population = filtered_df[population_col].sum() / 1_000_000
            st.metric("ğŸ‘¥ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚", f"{total_population:.1f}M")
        else:
            st.metric("ğŸ‘¥ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚", "N/A")
    
    # Interactive charts in multiple rows
    st.subheader("ğŸ“Š Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ¬ Î“ÏÎ±Ï†Î®Î¼Î±Ï„Î±")
    
    # First row - Regional and Prefecture distribution
    col1, col2 = st.columns(2)
    
    with col1:
        # Interactive regional pie chart
        if len(filtered_df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'].unique()) > 1:
            region_counts = filtered_df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'].value_counts()
            
            fig = go.Figure(data=[go.Pie(
                labels=region_counts.index,
                values=region_counts.values,
                hole=0.3,
                textinfo='label+percent+value',
                textposition='auto',
                marker=dict(
                    colors=['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                           '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA']
                )
            )])
            
            fig.update_layout(
                title={
                    'text': "ğŸ“ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î­ÏÎ³Ï‰Î½ Î±Î½Î¬ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±",
                    'x': 0.5,
                    'xanchor': 'center'
                },
                showlegend=True,
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.info("ğŸ“ ÎœÎ¯Î± Ï€ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î·")
    
    with col2:
        # Interactive prefecture bar chart
        prefecture_counts = filtered_df['ÎÎ¿Î¼ÏŒÏ‚'].value_counts().head(10)
        if not prefecture_counts.empty:
            
            fig = go.Figure(data=[go.Bar(
                y=prefecture_counts.index,
                x=prefecture_counts.values,
                orientation='h',
                marker=dict(
                    color=prefecture_counts.values,
                    colorscale='viridis',
                    showscale=True
                ),
                text=prefecture_counts.values,
                textposition='auto'
            )])
            
            fig.update_layout(
                title={
                    'text': "ğŸ›ï¸ Top 10 ÎÎ¿Î¼Î¿Î¯ (Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î­ÏÎ³Ï‰Î½)",
                    'x': 0.5,
                    'xanchor': 'center'
                },
                yaxis={'categoryorder': 'total ascending'},
                xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                yaxis_title="ÎÎ¿Î¼ÏŒÏ‚",
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
    
    # Second row - Project types and DEYA distribution
    col1, col2 = st.columns(2)
    
    with col1:
        # Interactive project types
        if 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…' in filtered_df.columns:
            project_types = filtered_df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'].value_counts().head(8)
            if not project_types.empty:
                
                fig = go.Figure(data=[go.Bar(
                    x=project_types.index,
                    y=project_types.values,
                    marker=dict(
                        color=project_types.values,
                        colorscale='blues',
                        showscale=True
                    ),
                    text=project_types.values,
                    textposition='auto'
                )])
                
                fig.update_layout(
                    title={
                        'text': "ğŸ—ï¸ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î±Î½Î¬ Î•Î¯Î´Î¿Ï‚ ÎˆÏÎ³Î¿Ï…",
                        'x': 0.5,
                        'xanchor': 'center'
                    },
                    xaxis_title="Î•Î¯Î´Î¿Ï‚ ÎˆÏÎ³Î¿Ï…",
                    yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                    xaxis={'tickangle': 45},
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.info("ğŸ—ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¹Î´ÏÎ½ Î­ÏÎ³Ï‰Î½")
    
    with col2:
        # Interactive DEYA distribution
        deya_counts = filtered_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].value_counts().head(10)
        if not deya_counts.empty:
            
            fig = go.Figure(data=[go.Pie(
                labels=deya_counts.index,
                values=deya_counts.values,
                textinfo='label+percent',
                textposition='auto',
                marker=dict(
                    colors=px.colors.qualitative.Set3
                )
            )])
            
            fig.update_layout(
                title={
                    'text': "ğŸ¢ Top 10 Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹",
                    'x': 0.5,
                    'xanchor': 'center'
                },
                showlegend=False,
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
    
    # Third row - Budget and Population analysis
    col1, col2 = st.columns(2)
    
    with col1:
        # Interactive budget distribution
        budget_cols = [col for col in filtered_df.columns if 'Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in str(col).lower() and filtered_df[col].dtype in ['int64', 'float64']]
        if budget_cols:
            budget_data = filtered_df[budget_cols[0]].dropna()
            if len(budget_data) > 0:
                # Create budget ranges
                budget_ranges = pd.cut(
                    budget_data,
                    bins=[0, 100000, 500000, 1000000, 5000000, float('inf')],
                    labels=['<100K', '100K-500K', '500K-1M', '1M-5M', '>5M'],
                    include_lowest=True
                ).value_counts()
                
                fig = go.Figure(data=[go.Pie(
                    labels=budget_ranges.index,
                    values=budget_ranges.values,
                    hole=0.4,
                    textinfo='label+percent+value',
                    marker=dict(
                        colors=['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd']
                    )
                )])
                
                fig.update_layout(
                    title={
                        'text': "ğŸ’° ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏÎ½",
                        'x': 0.5,
                        'xanchor': 'center'
                    },
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.info("ğŸ’° Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏÎ½")
        else:
            st.info("ğŸ’° Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï")
    
    with col2:
        # Interactive priority distribution
        priority_cols = [col for col in filtered_df.columns if 'Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±' in str(col).lower()]
        if priority_cols:
            priority_data = filtered_df[priority_cols[0]].value_counts()
            if not priority_data.empty:
                
                # Color mapping for priorities
                priority_colors = []
                for priority in priority_data.index:
                    if '1Î·' in str(priority):
                        priority_colors.append('#ff4444')  # Red for high priority
                    elif '2Î·' in str(priority):
                        priority_colors.append('#ffaa44')  # Orange for medium priority
                    else:
                        priority_colors.append('#44ff44')  # Green for low priority
                
                fig = go.Figure(data=[go.Bar(
                    x=priority_data.index,
                    y=priority_data.values,
                    marker=dict(
                        color=priority_colors
                    ),
                    text=priority_data.values,
                    textposition='auto'
                )])
                
                fig.update_layout(
                    title={
                        'text': "â­ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î ÏÎ¿Ï„ÎµÏÎ±Î¹Î¿Ï„Î®Ï„Ï‰Î½",
                        'x': 0.5,
                        'xanchor': 'center'
                    },
                    xaxis_title="Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±",
                    yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                    xaxis={'tickangle': 45},
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.info("â­ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹Î¿Ï„Î®Ï„Ï‰Î½")
        else:
            st.info("â­ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚")
    
    # Fourth row - Timeline and Population analysis
    col1, col2 = st.columns(2)
    
    with col1:
        # Interactive timeline analysis
        time_cols = [col for col in filtered_df.columns if any(word in str(col).lower() for word in ['Ï‡ÏÏŒÎ½Î¿Ï‚', 'Î¼Î®Î½ÎµÏ‚', 'time', 'months'])]
        if time_cols:
            time_data = filtered_df[time_cols[0]].dropna()
            if len(time_data) > 0:
                
                fig = go.Figure(data=[go.Histogram(
                    x=time_data,
                    nbinsx=15,
                    marker=dict(
                        color='lightblue',
                        line=dict(color='darkblue', width=1)
                    )
                )])
                
                fig.update_layout(
                    title={
                        'text': "â±ï¸ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î§ÏÏŒÎ½Î¿Ï… ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚",
                        'x': 0.5,
                        'xanchor': 'center'
                    },
                    xaxis_title="ÎœÎ®Î½ÎµÏ‚",
                    yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.info("â±ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡ÏÏŒÎ½Î¿Ï…")
        else:
            st.info("â±ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· Ï‡ÏÏŒÎ½Î¿Ï…")
    
    with col2:
        # Interactive population analysis
        pop_cols = [col for col in filtered_df.columns if 'Ï€Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚' in str(col).lower() and filtered_df[col].dtype in ['int64', 'float64']]
        if pop_cols:
            pop_data = filtered_df[pop_cols[0]].dropna()
            if len(pop_data) > 0:
                # Create population ranges
                pop_ranges = pd.cut(
                    pop_data,
                    bins=[0, 1000, 5000, 10000, 50000, float('inf')],
                    labels=['<1K', '1K-5K', '5K-10K', '10K-50K', '>50K'],
                    include_lowest=True
                ).value_counts()
                
                fig = go.Figure(data=[go.Bar(
                    x=pop_ranges.index,
                    y=pop_ranges.values,
                    marker=dict(
                        color=pop_ranges.values,
                        colorscale='blues',
                        showscale=True
                    ),
                    text=pop_ranges.values,
                    textposition='auto'
                )])
                
                fig.update_layout(
                    title={
                        'text': "ğŸ‘¥ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î•Î¾Ï…Ï€Î·ÏÎµÏ„Î¿ÏÎ¼ÎµÎ½Î¿Ï… Î Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï",
                        'x': 0.5,
                        'xanchor': 'center'
                    },
                    xaxis_title="Î•ÏÏÎ¿Ï‚ Î Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï",
                    yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.info("ğŸ‘¥ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï")
        else:
            st.info("ğŸ‘¥ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· Ï€Î»Î·Î¸Ï…ÏƒÎ¼Î¿Ï")

    # Î Î­Î¼Ï€Ï„Î· ÏƒÎµÎ¹ÏÎ¬ - Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ Î”Î®Î¼Î¿/Î”Î•Î¥Î‘
    st.subheader("ğŸ¢ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î”Î•Î¥Î‘/Î”Î®Î¼Ï‰Î½")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Top Î”Î•Î¥Î‘ Î¼Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± Î­ÏÎ³Î±
        deya_projects = filtered_df.groupby('Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚').agg({
            'Î‘/Î‘': 'count',
            'ÎÎ¿Î¼ÏŒÏ‚': 'first'
        }).sort_values('Î‘/Î‘', ascending=False).head(15)
        
        # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± labels Î¼Îµ Î½Î¿Î¼ÏŒ
        labels_with_prefecture = [
            f"{deya} ({prefecture})" 
            for deya, prefecture in zip(deya_projects.index, deya_projects['ÎÎ¿Î¼ÏŒÏ‚'])
        ]
        
        fig = go.Figure(data=[go.Bar(
            y=[label[:40] + "..." if len(label) > 40 else label for label in labels_with_prefecture],
            x=deya_projects['Î‘/Î‘'],
            orientation='h',
            marker=dict(
                color=deya_projects['Î‘/Î‘'],
                colorscale='plasma',
                showscale=True
            ),
            text=deya_projects['Î‘/Î‘'],
            textposition='auto'
        )])
        
        fig.update_layout(
            title="ğŸ† Top 15 Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹ (Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½)",
            xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            height=600,
            yaxis={'categoryorder': 'total ascending'}
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î­ÏÎ³Ï‰Î½ Î±Î½Î¬ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Î”Î•Î¥Î‘
        deya_counts = filtered_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].value_counts()
        
        # ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î”Î•Î¥Î‘
        size_categories = []
        for count in deya_counts.values:
            if count >= 10:
                size_categories.append('ÎœÎµÎ³Î¬Î»Î± Î”Î•Î¥Î‘ (10+ Î­ÏÎ³Î±)')
            elif count >= 5:
                size_categories.append('ÎœÎµÏƒÎ±Î¯Î± Î”Î•Î¥Î‘ (5-9 Î­ÏÎ³Î±)')
            elif count >= 2:
                size_categories.append('ÎœÎ¹ÎºÏÎ¬ Î”Î•Î¥Î‘ (2-4 Î­ÏÎ³Î±)')
            else:
                size_categories.append('Î Î¿Î»Ï ÎœÎ¹ÎºÏÎ¬ Î”Î•Î¥Î‘ (1 Î­ÏÎ³Î¿)')
        
        size_distribution = pd.Series(size_categories).value_counts()
        
        fig = go.Figure(data=[go.Pie(
            labels=size_distribution.index,
            values=size_distribution.values,
            hole=0.4,
            textinfo='label+percent+value',
            marker=dict(
                colors=['#e74c3c', '#f39c12', '#f1c40f', '#95a5a6']
            )
        )])
        
        fig.update_layout(
            title="ğŸ“Š ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î”Î•Î¥Î‘ Î±Î½Î¬ ÎœÎ­Î³ÎµÎ¸Î¿Ï‚",
            height=600
        )
        st.plotly_chart(fig, use_container_width=True)

def create_project_progress_analysis(df, selected_region, selected_prefecture):
    """Create comprehensive project progress analysis tab."""
    
    st.subheader("ğŸ“Š Î‘Î½Î¬Î»Ï…ÏƒÎ· Î ÏÎ¿ÏŒÎ´Î¿Ï… ÎˆÏÎ³Ï‰Î½")
    st.markdown("Î•Î¹Ï‚ Î²Î¬Î¸Î¿Ï‚ Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„Î·Ï‚ Ï€ÏÎ¿ÏŒÎ´Î¿Ï… Î­ÏÎ³Ï‰Î½ Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï„Î¿ Word document")
    
    # Word-derived columns for analysis
    word_columns = {
        'Î¤Î¯Ï„Î»Î¿Ï‚ ÎˆÏÎ³Î¿Ï… (Word)': 'project_title_word',
        'Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·': 'current_status',
        'Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…': 'project_phase', 
        'Î¤ÎµÏ‡Î½Î¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±': 'technical_specs',
        'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚': 'dates',
        'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚': 'completion_percentage',
        'Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·': 'funding',
        'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎˆÎ³ÎºÏÎ¹ÏƒÎ·Ï‚': 'approval_status',
        'Î Î·Î³Î­Ï‚ Î±Ï€ÏŒ Word': 'sources'
    }
    
    # Check which columns exist
    available_word_columns = {k: v for k, v in word_columns.items() if k in df.columns}
    
    if not available_word_columns:
        st.error("âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÏƒÏ„Î®Î»ÎµÏ‚ Word. Î’ÎµÎ²Î±Î¹Ï‰Î¸ÎµÎ¯Ï„Îµ ÏŒÏ„Î¹ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Ï„Î¹Ï‚ ÏƒÏ„Î®Î»ÎµÏ‚ Î±Ï€ÏŒ X Î­Ï‰Ï‚ AF.")
        return
    
    st.success(f"âœ… Î’ÏÎ­Î¸Î·ÎºÎ±Î½ {len(available_word_columns)} ÏƒÏ„Î®Î»ÎµÏ‚ Word Î³Î¹Î± Î±Î½Î¬Î»Ï…ÏƒÎ·")
    
    # Progress Overview Metrics
    st.subheader("ğŸ¯ Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î ÏÎ¿ÏŒÎ´Î¿Ï…")
    
    col1, col2, col3, col4, col5 = st.columns(5)
    
    with col1:
        # Projects with status info
        if 'Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·' in df.columns:
            status_count = len(df[df['Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·'].notna() & (df['Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·'] != '')])
            st.metric("ğŸ“‹ ÎˆÏÎ³Î± Î¼Îµ ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·", f"{status_count:,}")
        
    with col2:
        # Projects with phase info
        if 'Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…' in df.columns:
            phase_count = len(df[df['Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…'].notna() & (df['Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…'] != '')])
            st.metric("âš™ï¸ ÎˆÏÎ³Î± Î¼Îµ Î¦Î¬ÏƒÎ·", f"{phase_count:,}")
    
    with col3:
        # Projects with completion percentage
        if 'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚' in df.columns:
            completion_count = len(df[df['Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚'].notna() & (df['Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚'] != '')])
            st.metric("ğŸ“ˆ ÎˆÏÎ³Î± Î¼Îµ % ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚", f"{completion_count:,}")
    
    with col4:
        # Projects with dates
        if 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚' in df.columns:
            dates_count = len(df[df['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚'].notna() & (df['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚'] != '')])
            st.metric("ğŸ“… ÎˆÏÎ³Î± Î¼Îµ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚", f"{dates_count:,}")
    
    with col5:
        # Projects with approval status
        if 'ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎˆÎ³ÎºÏÎ¹ÏƒÎ·Ï‚' in df.columns:
            approval_count = len(df[df['ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎˆÎ³ÎºÏÎ¹ÏƒÎ·Ï‚'].notna() & (df['ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· ÎˆÎ³ÎºÏÎ¹ÏƒÎ·Ï‚'] != '')])
            st.metric("âœ… ÎˆÏÎ³Î± Î¼Îµ ÎˆÎ³ÎºÏÎ¹ÏƒÎ·", f"{approval_count:,}")
    
    # Detailed Progress Analysis
    tab1, tab2, tab3, tab4 = st.tabs([
        "ğŸ“Š Î‘Î½Î¬Î»Ï…ÏƒÎ· Î¦Î¬ÏƒÎµÏ‰Î½", 
        "ğŸ“ˆ Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚", 
        "ğŸ“… Î§ÏÎ¿Î½Î¹ÎºÎ® Î‘Î½Î¬Î»Ï…ÏƒÎ·", 
        "ğŸ’° Î‘Î½Î¬Î»Ï…ÏƒÎ· Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚"
    ])
    
    with tab1:
        create_phase_analysis(df)
    
    with tab2:
        create_completion_analysis(df)
    
    with tab3:
        create_timeline_analysis(df)
    
    with tab4:
        create_funding_analysis(df, selected_region, selected_prefecture)

def create_phase_analysis(df):
    """Detailed project phase analysis."""
    st.subheader("âš™ï¸ Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Î‘Î½Î¬Î»Ï…ÏƒÎ· Î¦Î¬ÏƒÎµÏ‰Î½ ÎˆÏÎ³Ï‰Î½")
    
    if 'Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…' not in df.columns:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· 'Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…'")
        return
    
    # Extract and analyze phases
    phase_data = df['Î¦Î¬ÏƒÎ· ÎˆÏÎ³Î¿Ï…'].dropna()
    all_phases = []
    
    for phases in phase_data:
        if isinstance(phases, str) and phases.strip():
            phase_list = [p.strip() for p in phases.split(';') if p.strip()]
            all_phases.extend(phase_list)
    
    if not all_phases:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï†Î¬ÏƒÎµÏ‰Î½")
        return
    
    # Phase distribution
    phase_counts = pd.Series(all_phases).value_counts()
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Interactive phase distribution chart
        fig = go.Figure(data=[go.Bar(
            x=phase_counts.values,
            y=phase_counts.index,
            orientation='h',
            marker=dict(
                color=phase_counts.values,
                colorscale='viridis',
                showscale=True
            ),
            text=phase_counts.values,
            textposition='auto'
        )])
        
        fig.update_layout(
            title="ğŸ“Š ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦Î¬ÏƒÎµÏ‰Î½ ÎˆÏÎ³Ï‰Î½",
            xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            yaxis_title="Î¦Î¬ÏƒÎ·",
            height=500,
            yaxis={'categoryorder': 'total ascending'}
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Phase progression pie chart
        fig = go.Figure(data=[go.Pie(
            labels=phase_counts.index[:8],  # Top 8 phases
            values=phase_counts.values[:8],
            hole=0.3,
            textinfo='label+percent'
        )])
        
        fig.update_layout(
            title="ğŸ”„ ÎšÏ…ÎºÎ»Î¹ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î¦Î¬ÏƒÎµÏ‰Î½",
            height=500
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # Phase progression mapping
    st.subheader("ğŸ“‹ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¦Î¬ÏƒÎµÏ‰Î½")
    
    # Define phase categories
    phase_categories = {
        'Î ÏÎ¿ÎºÎ±Ï„Î±ÏÎºÏ„Î¹ÎºÎ­Ï‚ Î¦Î¬ÏƒÎµÎ¹Ï‚': ['ÎœÎµÎ»Î­Ï„Î·', 'Î£Ï‡ÎµÎ´Î¹Î±ÏƒÎ¼ÏŒÏ‚', 'ÎˆÎ³ÎºÏÎ¹ÏƒÎ·', 'Î ÏÎ¿ÎºÎ®ÏÏ…Î¾Î·'],
        'Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯ÎµÏ‚ Î‘Î½Î¬Î¸ÎµÏƒÎ·Ï‚': ['Î”Î¹Î±ÎºÎ®ÏÏ…Î¾Î·', 'Î”Î·Î¼Î¿Ï€ÏÎ¬Ï„Î·ÏƒÎ·', 'Î”Î¹Î±Î³Ï‰Î½Î¹ÏƒÎ¼ÏŒÏ‚', 'Î‘Î½Î¬Î¸ÎµÏƒÎ·'],
        'Î¥Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·': ['ÎšÎ±Ï„Î±ÏƒÎºÎµÏ…Î®', 'Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·', 'Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚', 'Î¥Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ·'],
        'ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·': ['ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·', 'Î Î±ÏÎ±Î»Î±Î²Î®', 'Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±']
    }
    
    # Categorize phases
    categorized_phases = {category: 0 for category in phase_categories.keys()}
    uncategorized_phases = []
    
    for phase in all_phases:
        categorized = False
        for category, keywords in phase_categories.items():
            if any(keyword.lower() in phase.lower() for keyword in keywords):
                categorized_phases[category] += 1
                categorized = True
                break
        if not categorized:
            uncategorized_phases.append(phase)
    
    # Display categorized results
    col1, col2 = st.columns(2)
    
    with col1:
        # Category breakdown
        fig = go.Figure(data=[go.Bar(
            x=list(categorized_phases.keys()),
            y=list(categorized_phases.values()),
            marker=dict(
                color=['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4']
            ),
            text=list(categorized_phases.values()),
            textposition='auto'
        )])
        
        fig.update_layout(
            title="ğŸ“Š ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î¦Î¬ÏƒÎµÏ‰Î½",
            xaxis_title="ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î¦Î¬ÏƒÎ·Ï‚",
            yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Progress funnel
        total_projects = sum(categorized_phases.values())
        if total_projects > 0:
            percentages = [v/total_projects*100 for v in categorized_phases.values()]
            
            fig = go.Figure(go.Funnel(
                y=list(categorized_phases.keys()),
                x=list(categorized_phases.values()),
                textinfo="value+percent initial"
            ))
            
            fig.update_layout(
                title="ğŸ”½ Î”Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î± Î•Î¾Î­Î»Î¹Î¾Î·Ï‚ ÎˆÏÎ³Ï‰Î½",
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
    
    # Detailed phase table
    st.subheader("ğŸ“‹ Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î Î¯Î½Î±ÎºÎ±Ï‚ Î¦Î¬ÏƒÎµÏ‰Î½")
    
    phase_df = pd.DataFrame({
        'Î¦Î¬ÏƒÎ·': phase_counts.index,
        'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½': phase_counts.values,
        'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ': (phase_counts.values / len(df) * 100).round(1)
    })
    
    st.dataframe(phase_df, use_container_width=True)

def create_completion_analysis(df):
    """Analyze project completion percentages."""
    st.subheader("ğŸ“ˆ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î Î¿ÏƒÎ¿ÏƒÏ„Î¿Ï ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚")
    
    if 'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚' not in df.columns:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· 'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚'")
        return
    
    # Extract completion percentages
    completion_data = df['Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚'].dropna()
    
    # Parse percentages from text
    completion_values = []
    for comp in completion_data:
        if isinstance(comp, str):
            # Extract numbers followed by %
            percentages = re.findall(r'(\d+)%', comp)
            if percentages:
                completion_values.extend([int(p) for p in percentages])
    
    if not completion_values:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­Î³ÎºÏ…ÏÎ± Ï€Î¿ÏƒÎ¿ÏƒÏ„Î¬ Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚")
        return
    
    # Statistics
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        avg_completion = np.mean(completion_values)
        st.metric("ğŸ“Š ÎœÎ­ÏƒÎ¿ Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ", f"{avg_completion:.1f}%")
    
    with col2:
        median_completion = np.median(completion_values)
        st.metric("ğŸ“Š Î”Î¹Î¬Î¼ÎµÏƒÎ¿ Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ", f"{median_completion:.1f}%")
    
    with col3:
        max_completion = np.max(completion_values)
        st.metric("ğŸ“Š ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ", f"{max_completion}%")
    
    with col4:
        completed_projects = sum(1 for v in completion_values if v >= 100)
        st.metric("âœ… ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î±", f"{completed_projects}")
    
    # Completion distribution
    col1, col2 = st.columns(2)
    
    with col1:
        # Histogram of completion percentages
        fig = go.Figure(data=[go.Histogram(
            x=completion_values,
            nbinsx=20,
            marker=dict(
                color='lightblue',
                line=dict(color='darkblue', width=1)
            )
        )])
        
        fig.update_layout(
            title="ğŸ“Š ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î¿ÏƒÎ¿ÏƒÏ„ÏÎ½ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚",
            xaxis_title="Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚ (%)",
            yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Completion ranges
        ranges = ['0-25%', '26-50%', '51-75%', '76-99%', '100%']
        range_counts = [
            sum(1 for v in completion_values if 0 <= v <= 25),
            sum(1 for v in completion_values if 26 <= v <= 50),
            sum(1 for v in completion_values if 51 <= v <= 75),
            sum(1 for v in completion_values if 76 <= v <= 99),
            sum(1 for v in completion_values if v >= 100)
        ]
        
        fig = go.Figure(data=[go.Pie(
            labels=ranges,
            values=range_counts,
            hole=0.4,
            marker=dict(
                colors=['#ff6b6b', '#ffa726', '#ffee58', '#66bb6a', '#4caf50']
            )
        )])
        
        fig.update_layout(
            title="ğŸ¯ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ Î ÏÎ¿ÏŒÎ´Î¿Ï…",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)

def create_timeline_analysis(df):
    """Analyze project timelines and dates."""
    st.subheader("ğŸ“… Î§ÏÎ¿Î½Î¹ÎºÎ® Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎˆÏÎ³Ï‰Î½")
    
    if 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚' not in df.columns:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚'")
        return
    
    # Extract dates
    date_data = df['Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚'].dropna()
    all_dates = []
    
    for dates in date_data:
        if isinstance(dates, str) and dates.strip():
            # Extract dates in various formats
            date_patterns = [
                r'\b(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b',
                r'\b(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2})\b'
            ]
            
            for pattern in date_patterns:
                found_dates = re.findall(pattern, dates)
                all_dates.extend(found_dates)
    
    if not all_dates:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­Î³ÎºÏ…ÏÎµÏ‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚")
        return
    
    # Parse dates
    parsed_dates = []
    for date_str in all_dates:
        try:
            # Try different date formats
            for fmt in ['%d/%m/%Y', '%d-%m-%Y', '%d.%m.%Y', '%d/%m/%y']:
                try:
                    parsed_date = pd.to_datetime(date_str, format=fmt)
                    parsed_dates.append(parsed_date)
                    break
                except:
                    continue
        except:
            continue
    
    if not parsed_dates:
        st.warning("âš ï¸ Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Î±Î½Î¬Î»Ï…ÏƒÎ· Ï„Ï‰Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¹ÏÎ½")
        return
    
    # Timeline statistics
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        min_date = min(parsed_dates)
        st.metric("ğŸ“… Î Î±Î»Î±Î¹ÏŒÏ„ÎµÏÎ· Î—Î¼/Î½Î¯Î±", min_date.strftime('%d/%m/%Y'))
    
    with col2:
        max_date = max(parsed_dates)
        st.metric("ğŸ“… ÎÎµÏŒÏ„ÎµÏÎ· Î—Î¼/Î½Î¯Î±", max_date.strftime('%d/%m/%Y'))
    
    with col3:
        date_span = (max_date - min_date).days
        st.metric("ğŸ“Š Î§ÏÎ¿Î½Î¹ÎºÏŒ Î•ÏÏÎ¿Ï‚", f"{date_span} Î·Î¼Î­ÏÎµÏ‚")
    
    with col4:
        total_dates = len(parsed_dates)
        st.metric("ğŸ“Š Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î—Î¼/Î½Î¯ÎµÏ‚", f"{total_dates}")
    
    # Timeline visualization
    # Group dates by year and month
    date_df = pd.DataFrame({'Date': parsed_dates})
    date_df['Year'] = date_df['Date'].dt.year
    date_df['Month'] = date_df['Date'].dt.month
    date_df['YearMonth'] = date_df['Date'].dt.to_period('M')
    
    monthly_counts = date_df.groupby('YearMonth').size().reset_index(name='Count')
    monthly_counts['YearMonth_str'] = monthly_counts['YearMonth'].astype(str)
    
    fig = go.Figure(data=[go.Scatter(
        x=monthly_counts['YearMonth_str'],
        y=monthly_counts['Count'],
        mode='lines+markers',
        line=dict(color='blue', width=2),
        marker=dict(size=8)
    )])
    
    fig.update_layout(
        title="ğŸ“ˆ Î§ÏÎ¿Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎˆÏÎ³Ï‰Î½",
        xaxis_title="Î§ÏÎ¿Î½Î¹ÎºÎ® Î ÎµÏÎ¯Î¿Î´Î¿Ï‚",
        yaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¹ÏÎ½",
        height=400
    )
    st.plotly_chart(fig, use_container_width=True)

def create_funding_analysis(df, selected_region, selected_prefecture):
    """Analyze project funding sources."""
    st.subheader("ğŸ’° Î‘Î½Î¬Î»Ï…ÏƒÎ· Î Î·Î³ÏÎ½ Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚")
    
    if 'Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·' not in df.columns:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ ÏƒÏ„Î®Î»Î· 'Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·'")
        return
    
    # Extract funding sources
    funding_data = df['Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·'].dropna()
    all_funding = []
    
    for funding in funding_data:
        if isinstance(funding, str) and funding.strip():
            funding_list = [f.strip() for f in funding.split(';') if f.strip()]
            all_funding.extend(funding_list)
    
    if not all_funding:
        st.warning("âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï‡ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚")
        return
    
    # Funding distribution
    funding_counts = pd.Series(all_funding).value_counts()
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Funding sources bar chart
        fig = go.Figure(data=[go.Bar(
            x=funding_counts.values,
            y=funding_counts.index,
            orientation='h',
            marker=dict(
                color=funding_counts.values,
                colorscale='blues',
                showscale=True
            ),
            text=funding_counts.values,
            textposition='auto'
        )])
        
        fig.update_layout(
            title="ğŸ’° ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î Î·Î³ÏÎ½ Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚",
            xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            yaxis_title="Î Î·Î³Î® Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚",
            height=500,
            yaxis={'categoryorder': 'total ascending'}
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Funding pie chart
        fig = go.Figure(data=[go.Pie(
            labels=funding_counts.index,
            values=funding_counts.values,
            textinfo='label+percent'
        )])
        
        fig.update_layout(
            title="ğŸ”„ Î Î¿ÏƒÎ¿ÏƒÏ„Î¹Î±Î¯Î± ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚",
            height=500
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # Detailed funding table
    st.subheader("ğŸ“‹ Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î Î¯Î½Î±ÎºÎ±Ï‚ Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚")
    
    funding_df = pd.DataFrame({
        'Î Î·Î³Î® Î§ÏÎ·Î¼Î±Ï„Î¿Î´ÏŒÏ„Î·ÏƒÎ·Ï‚': funding_counts.index,
        'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½': funding_counts.values,
        'Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ': (funding_counts.values / len(df) * 100).round(1)
    })
    
    st.dataframe(funding_df, use_container_width=True)

def create_summary_tables(df, selected_region=None, selected_prefecture=None):
    """Create interactive summary tables."""
    
    # Apply filters
    filtered_df = df.copy()
    
    if selected_region and selected_region != 'ÎŒÎ»ÎµÏ‚':
        filtered_df = filtered_df[filtered_df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'] == selected_region]
    
    if selected_prefecture and selected_prefecture != 'ÎŒÎ»Î¿Î¹':
        filtered_df = filtered_df[filtered_df['ÎÎ¿Î¼ÏŒÏ‚'] == selected_prefecture]
    
    st.subheader("ğŸ“Š Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¿Î¯ Î Î¯Î½Î±ÎºÎµÏ‚")
    
    # Prefecture summary
    if 'ÎÎ¿Î¼ÏŒÏ‚' in filtered_df.columns:
        st.write("**ğŸ›ï¸ Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒÏ‚ Î Î¯Î½Î±ÎºÎ±Ï‚ Î±Î½Î¬ ÎÎ¿Î¼ÏŒ**")
        
        # Dynamic aggregation
        agg_dict = {'Î‘/Î‘': 'count', 'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique'}
        
        # Dynamically find columns for budget, population, and time
        budget_cols = [col for col in filtered_df.columns if 'Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in str(col).lower() and pd.api.types.is_numeric_dtype(filtered_df[col])]
        pop_cols = [col for col in filtered_df.columns if 'Ï€Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚' in str(col).lower() and pd.api.types.is_numeric_dtype(filtered_df[col])]
        time_cols = [col for col in filtered_df.columns if any(word in str(col).lower() for word in ['Ï‡ÏÏŒÎ½Î¿Ï‚', 'Î¼Î®Î½ÎµÏ‚', 'time', 'months']) and pd.api.types.is_numeric_dtype(filtered_df[col])]

        # Add first found column of each type to aggregation
        if budget_cols:
            agg_dict[budget_cols[0]] = ['sum', 'mean']
        if pop_cols:
            agg_dict[pop_cols[0]] = 'sum'
        if time_cols:
            agg_dict[time_cols[0]] = 'mean'

        summary_data = filtered_df.groupby('ÎÎ¿Î¼ÏŒÏ‚').agg(agg_dict).round(0)
        
        # Flatten column names dynamically
        new_columns = ['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î”Î•Î¥Î‘']
        if budget_cols:
            new_columns.extend([f'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€. (â‚¬)', f'ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€. (â‚¬)'])
        if pop_cols:
            new_columns.append(f'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚')
        if time_cols:
            new_columns.append(f'ÎœÎ­ÏƒÎ¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ (ÎœÎ®Î½ÎµÏ‚)')

        summary_data.columns = new_columns
        
        # Sort by number of projects
        summary_data = summary_data.sort_values('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', ascending=False)
        
        # Format large numbers
        if budget_cols:
            for col in ['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€. (â‚¬)', 'ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€. (â‚¬)']:
                if col in summary_data.columns:
                    summary_data[col] = summary_data[col].apply(lambda x: f"{x:,.0f}" if pd.notna(x) else "N/A")
        
        if pop_cols and 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚' in summary_data.columns:
            summary_data['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚'] = summary_data['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚'].apply(
                lambda x: f"{x:,.0f}" if pd.notna(x) else "N/A"
            )
        if time_cols and 'ÎœÎ­ÏƒÎ¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ (ÎœÎ®Î½ÎµÏ‚)' in summary_data.columns:
            summary_data['ÎœÎ­ÏƒÎ¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ (ÎœÎ®Î½ÎµÏ‚)'] = summary_data['ÎœÎ­ÏƒÎ¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ (ÎœÎ®Î½ÎµÏ‚)'].apply(
                lambda x: f"{x:,.1f}" if pd.notna(x) else "N/A"
            )
        
        st.dataframe(summary_data, use_container_width=True)
    
    # DEYA summary
    st.write("**ğŸ¢ Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏŒÏ‚ Î Î¯Î½Î±ÎºÎ±Ï‚ Î±Î½Î¬ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿**")
    
    deya_summary = filtered_df.groupby('Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚').agg({
        'Î‘/Î‘': 'count',
        'ÎÎ¿Î¼ÏŒÏ‚': 'first',
        'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±': 'first'
    }).rename(columns={
        'Î‘/Î‘': 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½',
        'ÎÎ¿Î¼ÏŒÏ‚': 'ÎÎ¿Î¼ÏŒÏ‚',
        'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±': 'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'
    }).sort_values('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', ascending=False)
    
    st.dataframe(deya_summary.head(20), use_container_width=True)

def main():
    """Main function to run the Streamlit app."""
    # Set page config at the top level
    st.set_page_config(
        page_title="Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ ÎˆÏÎ³Ï‰Î½ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # Add custom CSS for better performance
    st.markdown("""
    <style>
        /* Hide Streamlit default elements */
        .main > div:first-child { padding-top: 0; }
        /* Optimize rendering */
        .stDataFrame { width: 100% !important; }
        /* Improve sidebar performance */
        .sidebar .sidebar-content { will-change: auto; }
    </style>
    """, unsafe_allow_html=True)
    
    # --- Sidebar --- #
    with st.sidebar:
        # Clear cache button
        if st.button('ğŸ”„ Î•Ï€Î±Î½Î±Ï†ÏŒÏÏ„Ï‰ÏƒÎ· & ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Cache'):
            st.cache_data.clear()
            st.rerun()
            
        # Logo handling with multiple fallback paths
        logo_paths = [
            os.path.join(os.path.dirname(os.path.abspath(__file__)), "logo.png"),
            os.path.join(os.path.dirname(os.path.abspath(__file__)), "..", "logo.png"),
            os.path.join(os.path.dirname(os.path.abspath(__file__)), "loho.png"),
            os.path.join(os.path.dirname(os.path.abspath(__file__)), "..", "loho.png")
        ]
        
        logo_found = False
        for path in logo_paths:
            if os.path.exists(path):
                st.image(path, use_container_width=True)
                logo_found = True
                break
                
        if not logo_found:
            st.markdown("### ğŸ—ºï¸ ÎˆÏÎ³Î± ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚")
            
        st.title("ğŸ—ºï¸ Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ ÎˆÏÎ³Ï‰Î½ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚")
        st.markdown("---")
    
    # Main content
    st.title("ğŸ—ºï¸ Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ ÎˆÏÎ³Ï‰Î½ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚ Î•Î»Î»Î¬Î´Î±Ï‚")
    st.markdown("**ğŸš€ Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ® Î±Î½Î¬Î»Ï…ÏƒÎ· Î­ÏÎ³Ï‰Î½ ÏÎ´ÏÎµÏ…ÏƒÎ·Ï‚ Î±Î½Î¬ Î½Î¿Î¼ÏŒ ÎºÎ±Î¹ Ï€ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±**")
    
    # Enhanced sidebar
    with st.sidebar:
        st.header("ğŸ“‚ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½")
        
        # Add sample data option
        use_sample_data = st.checkbox("Î§ÏÎ®ÏƒÎ· Î´ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½", value=False)
        
        if not use_sample_data:
            uploaded_file = st.file_uploader(
                "ğŸ“Š Î‘Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿:", 
                type=['xlsx', 'xls'],
                help="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î±ÏÏ‡ÎµÎ¯Î¿ Excel Î¼Îµ Î­ÏÎ³Î± ÏÎ´ÏÎµÏ…ÏƒÎ·Ï‚"
            )
        else:
            # Provide sample data path
            sample_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "sample_data.xlsx")
            if os.path.exists(sample_path):
                uploaded_file = open(sample_path, 'rb')
                st.info("Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ Ï„Î± Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.")
            else:
                st.warning("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ¹Î³Î¼Î¬Ï„Ï‰Î½. Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿.")
                uploaded_file = None
        
        if uploaded_file:
            with st.spinner("â³ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÎºÎ±Î¹ Î±Î½Î¬Î»Ï…ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½..."):
                df = load_and_analyze_excel_enhanced(uploaded_file)
                
                if df is not None:
                    # Cache the loaded dataframe
                    st.session_state['df'] = df
                    
                    # Show success message with data stats
                    st.success(f"âœ… Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ {len(df):,} ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚ Î¼Îµ {len(df.columns)} Ï€ÎµÎ´Î¯Î±")
                    
                    # Enhanced statistics in expander for better organization
                    with st.expander("ğŸ“Š Î£Ï…Î½Î¿Ï€Ï„Î¹ÎºÎ¬ Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬", expanded=True):
                        # Regional breakdown with progress bars
                        if 'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±' in df.columns:
                            st.subheader("ğŸ—ºï¸ ÎˆÏÎ³Î± Î±Î½Î¬ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±")
                            region_counts = df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'].value_counts()
                            total = len(df)
                            
                            # Show top 5 regions with progress bars
                            for region, count in region_counts.head(5).items():
                                percentage = (count / total) * 100
                                st.write(f"**{region}**")
                                st.progress(percentage / 100, f"{count:,} Î­ÏÎ³Î± ({percentage:.1f}%)")
                            
                            # Show "other" if there are more regions
                            if len(region_counts) > 5:
                                other_count = total - sum(region_counts.head(5))
                                other_percentage = (other_count / total) * 100
                                st.write(f"**Î†Î»Î»ÎµÏ‚ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹ÎµÏ‚**")
                                st.progress(other_percentage / 100, f"{other_count:,} Î­ÏÎ³Î± ({other_percentage:.1f}%)")
                        
                        # Top prefectures with metrics
                        prefecture_counts = df['ÎÎ¿Î¼ÏŒÏ‚'].value_counts()
                        st.write("**ğŸ›ï¸ Top 5 ÎÎ¿Î¼Î¿Î¯:**")
                        for prefecture, count in prefecture_counts.head(5).items():
                            st.write(f"â€¢ {prefecture}: {count}")
                else:
                    st.error("âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï…")
                    return
        else:
            st.info("ğŸ‘† Î‘Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÏ„Îµ")
            return
    
    # Check if data exists
    if 'df' not in st.session_state:
        st.info("ğŸ“ Î Î±ÏÎ±ÎºÎ±Î»Ï Ï†Î¿ÏÏ„ÏÏƒÏ„Îµ Ï„Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Î±Ï€ÏŒ Ï„Î·Î½ Ï€Î»Î±ÏŠÎ½Î® Î¼Ï€Î¬ÏÎ±")
        return
    
    df = st.session_state['df']
    
    # Enhanced filter section
    st.subheader("ğŸ¯ Î¦Î¯Î»Ï„ÏÎ± Î•Ï€Î¹Î»Î¿Î³Î®Ï‚")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        regions = ['ÎŒÎ»ÎµÏ‚'] + sorted(df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'].unique().tolist())
        selected_region = st.selectbox(
            "ğŸ—ºï¸ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±:",
            regions,
            key="region_selector"
        )
    
    with col2:
        # Dynamic prefecture selection
        if selected_region and selected_region != 'ÎŒÎ»ÎµÏ‚':
            available_prefectures = sorted(df[df['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'] == selected_region]['ÎÎ¿Î¼ÏŒÏ‚'].unique())
        else:
            available_prefectures = sorted(df['ÎÎ¿Î¼ÏŒÏ‚'].unique())
        
        prefectures = ['ÎŒÎ»Î¿Î¹'] + available_prefectures
        selected_prefecture = st.selectbox(
            "ğŸ›ï¸ ÎÎ¿Î¼ÏŒÏ‚:",
            prefectures,
            key="prefecture_selector"
        )
    
    with col3:
        # Quick project type filter
        project_types = ['ÎŒÎ»Î±'] + sorted(df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'].dropna().unique())
        selected_type = st.selectbox(
            "ğŸ—ï¸ Î•Î¯Î´Î¿Ï‚ ÎˆÏÎ³Î¿Ï…:",
            project_types,
            key="quick_type_filter"
        )
    
    # Apply quick filter
    display_df = df.copy()
    if selected_type != 'ÎŒÎ»Î±':
        display_df = display_df[display_df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'] == selected_type]
    
    # Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ® Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
    with st.expander("ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎˆÏÎ³Ï‰Î½", expanded=False):
        col1, col2, col3 = st.columns(3)
        
        with col1:
            search_title = st.text_input(
                "ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ„Î¿Î½ Ï„Î¯Ï„Î»Î¿:",
                key="search_title"
            )
        
        with col2:
            search_deya = st.selectbox(
                "ğŸ¢ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Ï‚:",
                ['ÎŒÎ»Î±'] + sorted(df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique()),
                key="search_deya"
            )
        
        with col3:
            # Î¦Î¯Î»Ï„ÏÎ¿ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï
            budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
            if budget_col in df.columns:
                budget_values = df[budget_col].dropna()
                if len(budget_values) > 0:
                    min_budget, max_budget = st.slider(
                        "ğŸ’° Î•ÏÏÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï (â‚¬):",
                        min_value=int(budget_values.min()),
                        max_value=int(budget_values.max()),
                        value=(int(budget_values.min()), int(budget_values.max())),
                        step=10000,
                        key="budget_slider"
                    )
        
        # Î•Ï†Î±ÏÎ¼Î¿Î³Î® Ï†Î¯Î»Ï„ÏÏ‰Î½ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚
        search_df = df.copy()
        
        if search_title:
            title_col = next((col for col in df.columns if 'Ï„Î¯Ï„Î»Î¿Ï‚' in col.lower()), None)
            if title_col:
                search_df = search_df[search_df[title_col].str.contains(search_title, case=False, na=False)]
        
        if search_deya != 'ÎŒÎ»Î±':
            search_df = search_df[search_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'] == search_deya]
        
        if budget_col in df.columns and 'min_budget' in locals():
            search_df = search_df[
                (search_df[budget_col] >= min_budget) & 
                (search_df[budget_col] <= max_budget)
            ]
        
        if len(search_df) != len(df):
            st.success(f"ğŸ¯ Î’ÏÎ­Î¸Î·ÎºÎ±Î½ {len(search_df):,} Î­ÏÎ³Î± Ï€Î¿Ï… Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½ ÏƒÏ„Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±")
            
            # Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½
            display_columns = [
                col for col in ['Î¤Î¯Ï„Î»Î¿Ï‚ ÎˆÏÎ³Î¿Ï…', 'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚', 'ÎÎ¿Î¼ÏŒÏ‚', budget_col, 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…']
                if col in search_df.columns
            ]
            
            st.dataframe(search_df[display_columns].head(10), use_container_width=True)
            
            if len(search_df) > 10:
                st.info(f"ğŸ“‹ Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï„Î± Ï€ÏÏÏ„Î± 10 Î±Ï€ÏŒ {len(search_df)} Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±")
            
            # Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Ï‰Î½ display_df Î³Î¹Î± Ï„Î¹Ï‚ ÎºÎ±ÏÏ„Î­Î»ÎµÏ‚
            display_df = search_df.copy()

    # Create tabs for different views
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "ğŸ—ºï¸ Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ Î±Î½Î¬ ÎÎ¿Î¼ÏŒ", 
        "ğŸ“Š Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÎ¬ Î“ÏÎ±Ï†Î®Î¼Î±Ï„Î±", 
        "ğŸ“‹ Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÎ¿Î¯ Î Î¯Î½Î±ÎºÎµÏ‚",
        "ğŸ” Î‘Î½Î¬Î»Ï…ÏƒÎ· Î ÏÎ¿ÏŒÎ´Î¿Ï… ÎˆÏÎ³Ï‰Î½",
        "ğŸ“ Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎÎ¿Î¼ÏŒ/Î”Î®Î¼Î¿"
    ])

    with tab1:
        st.subheader("ğŸ—ºï¸ Î”Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒÏ‚ Î§Î¬ÏÏ„Î·Ï‚ Î±Î½Î¬ ÎÎ¿Î¼ÏŒ")
        m = create_interactive_map_by_prefecture(display_df)
        map_data = st_folium(m, width=725, height=500)  # Render map and capture interaction
        if map_data and 'last_clicked_popup' in map_data and map_data['last_clicked_popup']:
            popup_html = map_data['last_clicked_popup']['html']
            prefecture_name_match = re.search(r'<h3>(.*?)</h3>', popup_html)
            if prefecture_name_match:
                prefecture_name = prefecture_name_match.group(1).strip()
                st.session_state['selected_prefecture_from_map'] = prefecture_name
        
        if 'selected_prefecture_from_map' in st.session_state and st.session_state['selected_prefecture_from_map']:
            st.subheader(f"ÎˆÏÎ³Î± Î³Î¹Î± Ï„Î¿ ÎÎ¿Î¼ÏŒ: {st.session_state['selected_prefecture_from_map']}")
            prefecture_projects = display_df[display_df['ÎÎ¿Î¼ÏŒÏ‚'] == st.session_state['selected_prefecture_from_map']]
            st.dataframe(prefecture_projects, use_container_width=True)
    
    with tab2:
        create_interactive_charts(display_df, selected_region, selected_prefecture)
    
    with tab3:
        create_summary_tables(display_df, selected_region, selected_prefecture)
    
    with tab4:
        create_project_progress_analysis(display_df, selected_region, selected_prefecture)

    with tab5:
        create_detailed_regional_analysis(display_df, selected_region, selected_prefecture)

    # Data export functionality
    with st.expander("ğŸ“ Î•Î¾Î±Î³Ï‰Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½"):
        export_format = st.selectbox("Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¼Î¿ÏÏ†Î® ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚:", ["CSV", "Excel"])
        if export_format == "CSV":
            @st.cache
            def convert_df(df):
                return df.to_csv(index=False).encode('utf-8')
            csv = convert_df(display_df)
            st.download_button("Î•Î¾Î±Î³Ï‰Î³Î® CSV", csv, "data.csv", "text/csv")
        elif export_format == "Excel":
            @st.cache
            def convert_df(df):
                return df.to_excel(index=False).encode('utf-8')
            excel = convert_df(display_df)
            st.download_button("Î•Î¾Î±Î³Ï‰Î³Î® Excel", excel, "data.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")

def create_detailed_regional_analysis(df, selected_region=None, selected_prefecture=None):
    """Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î±Î½Î¬Î»Ï…ÏƒÎ· Î­ÏÎ³Ï‰Î½ Î±Î½Î¬ Î½Î¿Î¼ÏŒ ÎºÎ±Î¹ Î´Î®Î¼Î¿ Î¼Îµ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚."""
    
    st.subheader("ğŸ“ Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎÎ¿Î¼ÏŒ/Î”Î®Î¼Î¿")
    st.markdown("Î•Î¾ÎµÏÎµÏ…Î½Î®ÏƒÏ„Îµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ Ï„Î± Î­ÏÎ³Î±, Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚ ÎºÎ±Î¹ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î½Î¿Î¼ÏŒ ÎºÎ±Î¹ Î´Î®Î¼Î¿")
    
    # Î¦Î¯Î»Ï„ÏÎ± ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚
    col1, col2, col3 = st.columns(3)
    
    with col1:
        analysis_level = st.radio(
            "ğŸ¯ Î•Ï€Î¯Ï€ÎµÎ´Î¿ Î‘Î½Î¬Î»Ï…ÏƒÎ·Ï‚:",
            ["Î‘Î½Î¬ ÎÎ¿Î¼ÏŒ", "Î‘Î½Î¬ Î”Î®Î¼Î¿/Î”Î•Î¥Î‘", "Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÎÎ¿Î¼ÏÎ½"],
            key="analysis_level"
        )
    
    with col2:
        # Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… Î½Î¿Î¼Î¿Ï Î³Î¹Î± Î²Î±Î¸ÏÏ„ÎµÏÎ· Î±Î½Î¬Î»Ï…ÏƒÎ·
        prefectures_list = ['ÎŒÎ»Î¿Î¹'] + sorted(df['ÎÎ¿Î¼ÏŒÏ‚'].unique().tolist())
        focus_prefecture = st.selectbox(
            "ğŸ›ï¸ Î•Ï€Î¹Î»Î¿Î³Î® ÎÎ¿Î¼Î¿Ï Î³Î¹Î± Î‘Î½Î¬Î»Ï…ÏƒÎ·:",
            prefectures_list,
            key="focus_prefecture"
        )
    
    with col3:
        # Î•Ï€Î¹Î»Î¿Î³Î® Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï… Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚
        analysis_param = st.selectbox(
            "ğŸ“Š Î Î±ÏÎ¬Î¼ÎµÏ„ÏÎ¿Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ·Ï‚:",
            ["Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚", "Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½", "Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚", "Î§ÏÏŒÎ½Î¿Ï‚ ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·Ï‚"],
            key="analysis_param"
        )
    
    # Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎµÏ€Î¯Ï€ÎµÎ´Î¿
    if analysis_level == "Î‘Î½Î¬ ÎÎ¿Î¼ÏŒ":
        create_prefecture_analysis(df, analysis_param, focus_prefecture)
    elif analysis_level == "Î‘Î½Î¬ Î”Î®Î¼Î¿/Î”Î•Î¥Î‘":
        create_municipality_analysis(df, analysis_param, focus_prefecture)
    else:
        create_prefecture_comparison(df, analysis_param)

def create_prefecture_analysis(df, analysis_param, focus_prefecture):
    """Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ Î½Î¿Î¼ÏŒ."""
    st.subheader("ğŸ›ï¸ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ ÎÎ¿Î¼ÏŒ")
    
    # Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
    pop_col = next((col for col in df.columns if 'Ï€Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚' in col.lower()), None)
    time_col = next((col for col in df.columns if any(word in col.lower() for word in ['Ï‡ÏÏŒÎ½Î¿Ï‚', 'Î¼Î®Î½ÎµÏ‚'])), None)
    
    # ÎŸÎ¼Î±Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±Î½Î¬ Î½Î¿Î¼ÏŒ
    prefecture_stats = df.groupby('ÎÎ¿Î¼ÏŒÏ‚').agg({
        'Î‘/Î‘': 'count',
        'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique',
        budget_col: ['sum', 'mean', 'count'] if budget_col in df.columns and df[budget_col].notna().sum() > 0 else 'count',
        pop_col: 'sum' if pop_col else 'count',
        time_col: 'mean' if time_col else 'count'
    }).round(2)
    
    # Flatten columns
    prefecture_stats.columns = [
        'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î”Î•Î¥Î‘/Î”Î®Î¼Ï‰Î½', 
        'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'ÎˆÏÎ³Î± Î¼Îµ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ',
        'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î Î»Î·Î¸Ï…ÏƒÎ¼ÏŒÏ‚', 'ÎœÎ­ÏƒÎ· Î”Î¹Î¬ÏÎºÎµÎ¹Î± (Î¼Î®Î½ÎµÏ‚)'
    ]
    
    # Top 10 Î½Î¿Î¼Î¿Î¯
    if analysis_param == "Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚" and 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in prefecture_stats.columns:
        sorted_stats = prefecture_stats.nlargest(10, 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚')
        metric_col = 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'
    else:
        sorted_stats = prefecture_stats.nlargest(10, 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½')
        metric_col = 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'
    
    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î³ÏÎ±Ï†Î·Î¼Î¬Ï„Ï‰Î½
    col1, col2 = st.columns(2)
    
    with col1:
        # Bar chart Î³Î¹Î± top Î½Î¿Î¼Î¿ÏÏ‚
        fig = go.Figure(data=[go.Bar(
            y=sorted_stats.index,
            x=sorted_stats[metric_col],
            orientation='h',
            marker=dict(
                color=sorted_stats[metric_col],
                colorscale='viridis',
                showscale=True
            ),
            text=[f"{x:,.0f}" for x in sorted_stats[metric_col]],
            textposition='auto'
        )])
        
        fig.update_layout(
            title=f"ğŸ† Top 10 ÎÎ¿Î¼Î¿Î¯ - {analysis_param}",
            xaxis_title=analysis_param,
            yaxis_title="ÎÎ¿Î¼ÏŒÏ‚",
            height=500,
            yaxis={'categoryorder': 'total ascending'}
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        # Pie chart Î³Î¹Î± Ï€ÎµÏÎ¹Ï†ÎµÏÎµÎ¹Î±ÎºÎ® ÎºÎ±Ï„Î±Î½Î¿Î¼Î®
        region_stats = df.groupby('Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±')['Î‘/Î‘'].count().reset_index()
        
        fig = go.Figure(data=[go.Pie(
            labels=region_stats['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±'],
            values=region_stats['Î‘/Î‘'],
            hole=0.3,
            textinfo='label+percent',
            marker=dict(colors=px.colors.qualitative.Set3)
        )])
        
        fig.update_layout(
            title="ğŸ—ºï¸ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎˆÏÎ³Ï‰Î½ Î±Î½Î¬ Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±",
            height=500
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚
    st.subheader("ğŸ“‹ Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Î Î¯Î½Î±ÎºÎ±Ï‚ ÎÎ¿Î¼ÏÎ½")
    
    # ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Î±ÏÎ¹Î¸Î¼ÏÎ½
    display_stats = prefecture_stats.copy()
    if 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in display_stats.columns:
        display_stats['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'] = display_stats['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].apply(
            lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) else "N/A"
        )
        display_stats['ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'] = display_stats['ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].apply(
            lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) else "N/A"
        )
    
    st.dataframe(display_stats.sort_values('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', ascending=False), use_container_width=True)
    
    # Î•Î¬Î½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎµ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï‚ Î½Î¿Î¼ÏŒÏ‚
    if focus_prefecture != 'ÎŒÎ»Î¿Î¹':
        st.subheader(f"ğŸ” Î•Î¹Ï‚ Î’Î¬Î¸Î¿Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ·: {focus_prefecture}")
        create_single_prefecture_deep_dive(df, focus_prefecture)

def create_municipality_analysis(df, analysis_param, focus_prefecture):
    """Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ Î´Î®Î¼Î¿/Î”Î•Î¥Î‘."""
    st.subheader("ğŸ¢ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î±Î½Î¬ Î”Î®Î¼Î¿/Î”Î•Î¥Î‘")
    
    # Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    if focus_prefecture != 'ÎŒÎ»Î¿Î¹':
        filtered_df = df[df['ÎÎ¿Î¼ÏŒÏ‚'] == focus_prefecture]
        st.info(f"ğŸ“ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î³Î¹Î± Ï„Î¿ ÎÎ¿Î¼ÏŒ: **{focus_prefecture}**")
    else:
        filtered_df = df.copy()
    
    # Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
    
    municipality_stats = filtered_df.groupby(['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚', 'ÎÎ¿Î¼ÏŒÏ‚']).agg({
        'Î‘/Î‘': 'count',
        budget_col: ['sum', 'mean'] if budget_col in filtered_df.columns else 'count',
        'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…': lambda x: x.mode().iloc[0] if len(x.mode()) > 0 else 'N/A'
    }).round(2)
    
    # Flatten columns
    municipality_stats.columns = ['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'ÎšÏÏÎ¹Î± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±']
    municipality_stats = municipality_stats.reset_index()
    
    # Sorting
    if analysis_param == "Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚":
        municipality_stats = municipality_stats.sort_values('Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', ascending=False)
    else:
        municipality_stats = municipality_stats.sort_values('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', ascending=False)
    
    # Top 15 Î´Î®Î¼Î¿Î¹
    top_municipalities = municipality_stats.head(15)
    
    # Î“ÏÎ±Ï†Î®Î¼Î±Ï„Î±
    col1, col2 = st.columns(2)
    
    with col1:
        # Horizontal bar chart
        fig = go.Figure(data=[go.Bar(
            y=[f"{row['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'][:25]}..." if len(row['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚']) > 25 else row['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'] 
               for _, row in top_municipalities.iterrows()],
            x=top_municipalities['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'],
            orientation='h',
            marker=dict(
                color=top_municipalities['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'],
                colorscale='blues',
                showscale=True
            ),
            text=top_municipalities['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'],
            textposition='auto',
            hovertemplate='<b>%{y}</b><br>ÎˆÏÎ³Î±: %{x}<br><extra></extra>'
        )])
        
        fig.update_layout(
            title="ğŸ† Top 15 Î”Î®Î¼Î¿Î¹/Î”Î•Î¥Î‘ (Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½)",
            xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
            height=600,
            yaxis={'categoryorder': 'total ascending'}
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        if 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in top_municipalities.columns:
            # Scatter plot: ÎˆÏÎ³Î± vs Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚
            fig = go.Figure(data=[go.Scatter(
                x=top_municipalities['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'],
                y=top_municipalities['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'],
                mode='markers+text',
                text=[name[:10] + "..." if len(name) > 10 else name 
                      for name in top_municipalities['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚']],
                textposition='top center',
                marker=dict(
                    size=top_municipalities['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'] * 2,
                    color=top_municipalities['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'],
                    colorscale='viridis',
                    showscale=True,
                    colorbar=dict(title="Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚")
                ),
                hovertemplate='<b>%{text}</b><br>ÎˆÏÎ³Î±: %{x}<br>Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚: â‚¬%{y:,.0f}<br><extra></extra>'
            )])
            
            fig.update_layout(
                title="ğŸ’° Î£Ï‡Î­ÏƒÎ· ÎˆÏÎ³Ï‰Î½ - Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï",
                xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                yaxis_title="Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (â‚¬)",
                height=600
            )
            st.plotly_chart(fig, use_container_width=True)
    
    # Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎ®Ï‚ Ï€Î¯Î½Î±ÎºÎ±Ï‚
    st.subheader("ğŸ“Š Î Î»Î®ÏÎ·Ï‚ Î Î¯Î½Î±ÎºÎ±Ï‚ Î”Î®Î¼Ï‰Î½/Î”Î•Î¥Î‘")
    
    # ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ·
    display_municipalities = municipality_stats.copy()
    if 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in display_municipalities.columns:
        display_municipalities['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'] = display_municipalities['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].apply(
            lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) else "N/A"
        )
        display_municipalities['ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'] = display_municipalities['ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].apply(
            lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) else "N/A"
        )
    
    # Pagination
    page_size = 20
    total_pages = len(display_municipalities) // page_size + (1 if len(display_municipalities) % page_size > 0 else 0)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        page_number = st.selectbox(
            f"ğŸ“„ Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÎµÎ»Î¯Î´Î± (1-{total_pages}):",
            range(1, total_pages + 1),
            key="municipality_page"
        )
    
    start_idx = (page_number - 1) * page_size
    end_idx = start_idx + page_size
    
    st.dataframe(
        display_municipalities.iloc[start_idx:end_idx],
        use_container_width=True
    )
    
    # Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("ğŸ¢ Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Î”Î®Î¼Î¿Î¹/Î”Î•Î¥Î‘", len(municipality_stats))
    with col2:
        total_projects = municipality_stats['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'].sum()
        st.metric("ğŸ—ï¸ Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏÎ³Î±", f"{total_projects:,}")
    with col3:
        if 'Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in municipality_stats.columns:
            total_budget = municipality_stats['Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].sum()
            st.metric("ğŸ’° Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚", f"â‚¬{total_budget:,.0f}")
    with col4:
        avg_projects = municipality_stats['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½'].mean()
        st.metric("ğŸ“Š ÎœÎ­ÏƒÎ¿Ï‚ Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½/Î”Î®Î¼Î¿", f"{avg_projects:.1f}")

def create_prefecture_comparison(df, analysis_param):
    """Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· Î½Î¿Î¼ÏÎ½."""
    st.subheader("âš–ï¸ Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÎÎ¿Î¼ÏÎ½")
    
    # Î•Ï€Î¹Î»Î¿Î³Î® Î½Î¿Î¼ÏÎ½ Î³Î¹Î± ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·
    col1, col2 = st.columns(2)
    
    with col1:
        available_prefectures = sorted(df['ÎÎ¿Î¼ÏŒÏ‚'].unique().tolist())
        selected_prefectures = st.multiselect(
            "ğŸ“ Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎÎ¿Î¼Î¿ÏÏ‚ Î³Î¹Î± Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· (max 6):",
            available_prefectures,
            default=available_prefectures[:6],
            max_selections=6,
            key="comparison_prefectures"
        )
    
    with col2:
        comparison_metrics = st.multiselect(
            "ğŸ“Š Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎœÎµÏ„ÏÎ¹ÎºÎ­Ï‚:",
            ["Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½", "Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚", "Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î”Î•Î¥Î‘", "ÎœÎ­ÏƒÎ· Î”Î¹Î¬ÏÎºÎµÎ¹Î±"],
            default=["Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½", "Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚"],
            key="comparison_metrics"
        )
    
    if not selected_prefectures:
        st.warning("âš ï¸ Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±Î½ Î½Î¿Î¼ÏŒ Î³Î¹Î± ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·")
        return
    
    # Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± ÎºÎ±Î¹ Ï€ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    comparison_df = df[df['ÎÎ¿Î¼ÏŒÏ‚'].isin(selected_prefectures)]
    
    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
    time_col = next((col for col in df.columns if any(word in col.lower() for word in ['Ï‡ÏÏŒÎ½Î¿Ï‚', 'Î¼Î®Î½ÎµÏ‚'])), None)
    
    comparison_stats = comparison_df.groupby('ÎÎ¿Î¼ÏŒÏ‚').agg({
        'Î‘/Î‘': 'count',
        'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique',
        budget_col: 'sum' if budget_col in comparison_df.columns else 'count',
        time_col: 'mean' if time_col else 'count'
    }).round(2)
    
    comparison_stats.columns = ['Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', 'Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ Î”Î•Î¥Î‘', 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'ÎœÎ­ÏƒÎ· Î”Î¹Î¬ÏÎºÎµÎ¹Î±']
    
    # Radar chart Î³Î¹Î± ÏƒÏÎ³ÎºÏÎ¹ÏƒÎ·
    if len(selected_prefectures) <= 3:
        fig = go.Figure()
        
        for prefecture in selected_prefectures:
            if prefecture in comparison_stats.index:
                values = []
                for metric in comparison_metrics:
                    if metric in comparison_stats.columns:
                        # Normalize values (0-100 scale)
                        max_val = comparison_stats[metric].max()
                        normalized_val = (comparison_stats.loc[prefecture, metric] / max_val) * 100
                        values.append(normalized_val)
                
                fig.add_trace(go.Scatterpolar(
                    r=values + [values[0]],  # Close the polygon
                    theta=comparison_metrics + [comparison_metrics[0]],
                    fill='toself',
                    name=prefecture
                ))
        
        fig.update_layout(
            polar=dict(
                radialaxis=dict(
                    visible=True,
                    range=[0, 100]
                )
            ),
            title="ğŸ“Š Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÎÎ¿Î¼ÏÎ½ (Normalized ÏƒÎµ ÎºÎ»Î¯Î¼Î±ÎºÎ± 0-100)",
            height=500
        )
        st.plotly_chart(fig, use_container_width=True)
    
    # Bar charts Î³Î¹Î± ÎºÎ¬Î¸Îµ Î¼ÎµÏ„ÏÎ¹ÎºÎ®
    for i, metric in enumerate(comparison_metrics):
        if metric in comparison_stats.columns:
            col1, col2 = st.columns(2) if i % 2 == 0 else (col2, col1)
            
            with col1 if i % 2 == 0 else col2:
                fig = go.Figure(data=[go.Bar(
                    x=comparison_stats.index,
                    y=comparison_stats[metric],
                    marker=dict(
                        color=comparison_stats[metric],
                        colorscale='viridis'
                    ),
                    text=[f"{x:,.0f}" for x in comparison_stats[metric]],
                    textposition='auto'
                )])
                
                fig.update_layout(
                    title=f"ğŸ“Š {metric}",
                    xaxis_title="ÎÎ¿Î¼ÏŒÏ‚",
                    yaxis_title=metric,
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)
    
    # Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÏƒÎµ Ï€Î¯Î½Î±ÎºÎ±
    st.subheader("ğŸ“‹ Î£Ï…Î³ÎºÏÎ¹Ï„Î¹ÎºÏŒÏ‚ Î Î¯Î½Î±ÎºÎ±Ï‚")
    
    display_comparison = comparison_stats.copy()
    if 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚' in display_comparison.columns:
        display_comparison['Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'] = display_comparison['Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'].apply(
            lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) else "N/A"
        )
    
    st.dataframe(display_comparison.sort_values('Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½', ascending=False), use_container_width=True)

def create_single_prefecture_deep_dive(df, prefecture_name):
    """Î•Î¹Ï‚ Î²Î¬Î¸Î¿Ï‚ Î±Î½Î¬Î»Ï…ÏƒÎ· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… Î½Î¿Î¼Î¿Ï."""
    prefecture_df = df[df['ÎÎ¿Î¼ÏŒÏ‚'] == prefecture_name].copy()
    
    if len(prefecture_df) == 0:
        st.warning(f"âš ï¸ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­ÏÎ³Î± Î³Î¹Î± Ï„Î¿ Î½Î¿Î¼ÏŒ {prefecture_name}")
        return
    
    # Î’Î±ÏƒÎ¹ÎºÎ¬ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬
    col1, col2, col3, col4 = st.columns(4)
    
    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
    
    with col1:
        total_projects = len(prefecture_df)
        st.metric("ğŸ—ï¸ Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏÎ³Î±", f"{total_projects:,}")
    
    with col2:
        unique_deya = len(prefecture_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique())
        st.metric("ğŸ¢ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿Î¹", unique_deya)
    
    with col3:
        if budget_col in prefecture_df.columns:
            total_budget = prefecture_df[budget_col].sum()
            st.metric("ğŸ’° Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚", f"â‚¬{total_budget:,.0f}")
    
    with col4:
        if budget_col in prefecture_df.columns:
            avg_budget = prefecture_df[budget_col].mean()
            st.metric("ğŸ“Š ÎœÎ­ÏƒÎ¿Ï‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚", f"â‚¬{avg_budget:,.0f}")
    
    # ÎšÎ±Ï„Î±Î½Î¿Î¼Î® Î±Î½Î¬ Î”Î•Î¥Î‘
    col1, col2 = st.columns(2)
    
    with col1:
        deya_counts = prefecture_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].value_counts()
        
        fig = go.Figure(data=[go.Pie(
            labels=deya_counts.index,
            values=deya_counts.values,
            textinfo='label+percent',
            hovertemplate='<b>%{label}</b><br>ÎˆÏÎ³Î±: %{value}<br>Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ: %{percent}<br><extra></extra>'
        )])
        
        fig.update_layout(
            title=f"ğŸ¢ ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎˆÏÎ³Ï‰Î½ Î±Î½Î¬ Î”Î•Î¥Î‘/Î”Î®Î¼Î¿ - {prefecture_name}",
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)
    
    with col2:
        if 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…' in prefecture_df.columns:
            category_counts = prefecture_df['ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'].value_counts()
            
            fig = go.Figure(data=[go.Bar(
                x=category_counts.values,
                y=category_counts.index,
                orientation='h',
                marker=dict(
                    color=category_counts.values,
                    colorscale='blues'
                ),
                text=category_counts.values,
                textposition='auto'
            )])
            
            fig.update_layout(
                title=f"ğŸ—ï¸ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚ ÎˆÏÎ³Ï‰Î½ - {prefecture_name}",
                xaxis_title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎˆÏÎ³Ï‰Î½",
                height=400,
                yaxis={'categoryorder': 'total ascending'}
            )
            st.plotly_chart(fig, use_container_width=True)
    
    # Î›Î¯ÏƒÏ„Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î­ÏÎ³Ï‰Î½
    st.subheader(f"ğŸ“‹ Î Î»Î®ÏÎ·Ï‚ Î›Î¯ÏƒÏ„Î± ÎˆÏÎ³Ï‰Î½ - {prefecture_name}")
    
    # Î•Ï€Î¹Î»Î¿Î³Î® ÏƒÏ„Î·Î»ÏÎ½ Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
    available_columns = [col for col in prefecture_df.columns if col not in ['normalized_utility']]
    default_columns = [
        'Î¤Î¯Ï„Î»Î¿Ï‚ ÎˆÏÎ³Î¿Ï…', 'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚', 
        budget_col if budget_col in prefecture_df.columns else 'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…',
        'ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± ÎˆÏÎ³Î¿Ï…'
    ]
    
    selected_columns = st.multiselect(
        "ğŸ“Š Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÏƒÏ„Î®Î»ÎµÏ‚ Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·:",
        available_columns,
        default=[col for col in default_columns if col in available_columns],
        key=f"columns_{prefecture_name}"
    )
    
    if selected_columns:
        # Î¦Î¯Î»Ï„ÏÎ¿ Î³Î¹Î± Î”Î•Î¥Î‘
        selected_deya = st.multiselect(
            "ğŸ¢ Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î±Î½Î¬ Î”Î•Î¥Î‘ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ):",
            sorted(prefecture_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].unique()),
            key=f"deya_filter_{prefecture_name}"
        )
        
        display_df = prefecture_df.copy()
        if selected_deya:
            display_df = display_df[display_df['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚'].isin(selected_deya)]
        
        # ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
        if budget_col in selected_columns and budget_col in display_df.columns:
            display_df[budget_col] = display_df[budget_col].apply(
                lambda x: f"â‚¬{x:,.0f}" if pd.notna(x) and x != 0 else "N/A"
            )
        
        st.dataframe(
            display_df[selected_columns].reset_index(drop=True),
            use_container_width=True
        )
        
        # ÎšÎ¿Ï…Î¼Ï€Î¯ ÎµÎ¾Î±Î³Ï‰Î³Î®Ï‚
        csv = display_df[selected_columns].to_csv(index=False)
        st.download_button(
            label=f"ğŸ“¥ Î•Î¾Î±Î³Ï‰Î³Î® ÏƒÎµ CSV - {prefecture_name}",
            data=csv,
            file_name=f"projects_{prefecture_name}.csv",
            mime="text/csv"
        )

def create_export_summary(df):
    """Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î³Î¹Î± ÎµÎ¾Î±Î³Ï‰Î³Î®."""
    budget_col = 'Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ (ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ® Î”Î” Ï€ÏÎ¿ Î¦Î Î‘)'
    
    summary = df.groupby(['Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±', 'ÎÎ¿Î¼ÏŒÏ‚']).agg({
        'Î‘/Î‘': 'count',
        'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique',
        budget_col: ['sum', 'mean', 'count'] if budget_col in df.columns else 'count'
    })
    
    return summary

def create_prefecture_export(df):
    """Î•Î¾Î±Î³Ï‰Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Î½Î¬ Î½Î¿Î¼ÏŒ."""
    return df.groupby('ÎÎ¿Î¼ÏŒÏ‚').agg({
        'Î‘/Î‘': 'count',
        'Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚': 'nunique',
        'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±': 'first'
    }).reset_index()

def create_municipality_export(df):
    """Î•Î¾Î±Î³Ï‰Î³Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Î½Î¬ Î´Î®Î¼Î¿."""
    return df.groupby(['Î¦Î¿ÏÎ­Î±Ï‚ ÎÎ´ÏÎµÏ…ÏƒÎ·Ï‚', 'ÎÎ¿Î¼ÏŒÏ‚']).agg({
        'Î‘/Î‘': 'count',
        'Î ÎµÏÎ¹Ï†Î­ÏÎµÎ¹Î±': 'first'
    }).reset_index()

    # Export Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
    st.subheader("ğŸ“¥ Î•Î¾Î±Î³Ï‰Î³Î® Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ“Š Î•Î¾Î±Î³Ï‰Î³Î® Î£Ï…Î³ÎºÎµÎ½Ï„ÏÏ‰Ï„Î¹ÎºÏÎ½", key="export_summary"):
            summary_data = create_export_summary(display_df)
            csv = summary_data.to_csv(index=True)
            st.download_button(
                label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± CSV",
                data=csv,
                file_name="water_projects_summary.csv",
                mime="text/csv"
            )
    
    with col2:
        if st.button("ğŸ›ï¸ Î•Î¾Î±Î³Ï‰Î³Î® Î±Î½Î¬ ÎÎ¿Î¼ÏŒ", key="export_prefectures"):
            prefecture_data = create_prefecture_export(display_df)
            csv = prefecture_data.to_csv(index=False)
            st.download_button(
                label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± CSV",
                data=csv,
                file_name="projects_by_prefecture.csv",
                mime="text/csv"
            )
    
    with col3:
        if st.button("ğŸ¢ Î•Î¾Î±Î³Ï‰Î³Î® Î±Î½Î¬ Î”Î•Î¥Î‘", key="export_municipalities"):
            municipality_data = create_municipality_export(display_df)
            csv = municipality_data.to_csv(index=False)
            st.download_button(
                label="â¬‡ï¸ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± CSV",
                data=csv,
                file_name="projects_by_municipality.csv",
                mime="text/csv"
            )

if __name__ == "__main__":
    main()